---
title: "02_STOPPD_GraphMetrics_pos"
output: html_notebook
---

# STOP-PD functional analyses with BCT graph metrics using proportional thresholding (negative values eliminated) at 15%

```{r}
library(tidyr)
library(dplyr)
library(tableone)
library(ggplot2)
library(lme4)
library(lmerTest)
library(broom)

```

```{r}
# read in clinical data for those who passed imaging QC (as per /projects/loliver/STOPPD_Long_FC/data/raw/stoppd_usable_rsFC_sublist_Nick.csv)
# original csv generated by Erin for the JAMA Psych paper
stpd_clin <- read.csv(file = "/projects/loliver/STOPPD_Long_FC/data/raw/STOPPD_clinical_fc.csv", header=T) %>%
  mutate(STUDYID = as.character(STUDYID),
         dateDiff = as.numeric(dateDiff),
         site = as.factor(site),
         RandomArm = factor(randomization, 
                           levels = c("O", "P"), labels = c("Olanzapine", "Placebo")),
         sex = factor(sex, levels = c("M", "F"), labels = c("Male", "Female")),
         ClinicalOutcome = factor(ClinicalOutcome, 
                             levels = c("Remission","Relapse", "Off protocol")),
         PlotLabel = factor(PlotLabel, 
                       levels = c("Sustained Remisson","Relapse", "Discontinued_Remission"),
                       labels = c("Sustained Remisson","Relapse", "Discontinued"))) 

# exclude 210012 (116 TRs vs 206), 210013 (116 TRs), 220002 (116 TRs), and 320006 (146 TRs) due to incomplete RS ses-01 data
# 220002 also has incomplete RS ses-02 data (116 TRs)  
stpd_clin <- stpd_clin[stpd_clin$STUDYID!="210012" & stpd_clin$STUDYID!="210013" & stpd_clin$STUDYID!="220002" & stpd_clin$STUDYID!="320006",]

# exclude 410012 and 320032 due to intracranial findings
stpd_clin <- stpd_clin[stpd_clin$STUDYID!="410012" & stpd_clin$STUDYID!="320032",]

# reorder data by ascending ID to align with matlab outputs
stpd_clin <- stpd_clin[order(stpd_clin$STUDYID),]

```

```{r}
# read in BCT metrics at 15% density using proportional thresholding across values (neg eliminated)
# cortical and subcortical ROIs
# clustering coefficient, global efficiency, transitivity, characteristic path length, modularity

# ses-01
conn_gt_15_t1 <- read.csv(file = "/projects/loliver/STOPPD_Long_FC/data/processed/graph_metrics/ses-01/pos_whole_15.csv", header=F, col.names = c("STUDYID","cc_t1","ge_t1","trans_t1","cpl_t1","q_t1")) %>% mutate(STUDYID = as.character(STUDYID))
conn_gt_15_t1$STUDYID <- stpd_clin$STUDYID # matlab csvwrite rounds after 5 digits (confirmed this is correct)

# ses-02
conn_gt_15_t2 <- read.csv(file = "/projects/loliver/STOPPD_Long_FC/data/processed/graph_metrics/ses-02/pos_whole_15.csv", header=F, col.names = c("STUDYID","cc_t2","ge_t2","trans_t2","cpl_t2","q_t2")) %>% mutate(STUDYID = as.character(STUDYID))
conn_gt_15_t2$STUDYID <- stpd_clin$STUDYID

# merge clinical and t1 and t2 conn data, and reorder columns
conn_gt_15 <- merge(conn_gt_15_t1,conn_gt_15_t2,by="STUDYID")
clin_gt_15 <- merge(stpd_clin,conn_gt_15,by="STUDYID")
clin_gt_15 <- clin_gt_15[,c(1:9,11,10,12,14,13,16,15,17,19,18)]

```

```{r}
# analyses as per the JAMA psych paper (following Erin's github) 

# Erin's plot colours
RandomArmColors = c("#e6ab02", "#386cb0")

# make difference scores
clin_gt_15$ge_diff <- clin_gt_15$ge_t2 - clin_gt_15$ge_t1
clin_gt_15$cc_diff <- clin_gt_15$cc_t2 - clin_gt_15$cc_t1
clin_gt_15$trans_diff <- clin_gt_15$trans_t2 - clin_gt_15$trans_t1
clin_gt_15$q_diff <- clin_gt_15$q_t2 - clin_gt_15$q_t1
clin_gt_15$cpl_diff <- clin_gt_15$cpl_t2 - clin_gt_15$cpl_t1

# table one with baseline values for GE, CC, transitivity, modularity
tbl_t1 <- CreateTableOne(data = clin_gt_15, strata = c("RandomArm"),
               vars = c("ClinicalOutcome", "ge_t1", "cc_t1", "trans_t1", "q_t1"))

print(tbl_t1,contDigits=3)

# also by site
#CreateTableOne(data = clin_gt_15, strata = c("RandomArm","site"),
#               vars = c("ClinicalOutcome", "ge_t1", "cc_t1", "trans_t1", "q_t1"))

# table one with longitudinal values
# CreateTableOne(data = clin_gt_15, strata = c("RandomArm"),
#               vars = c("ClinicalOutcome", "ge_t2", "cc_t2", "trans_t2", "q_t2"))

```

```{r}
# generate df with stats for baseline t-tests
t1_means_df <- data.frame(matrix(NA, nrow = 4, ncol = 5))
rownames(t1_means_df) <- colnames(clin_gt_15[,c(10:13)])
colnames(t1_means_df) <- c("mean_olan","mean_plac","t","df","p")

for (i in colnames(clin_gt_15[,c(10:13)])) {
  t1_means_df[i,] <- c(tidy(t.test(get(i) ~ RandomArm, data = clin_gt_15, paired=F))[,c("estimate1","estimate2","statistic","parameter","p.value")])
}

# add fdr-corrected p values and sd values, then reorder columns 
t1_means_df$p_fdr <- p.adjust(t1_means_df$p, method = "fdr")
t1_means_df$sd_olan <- c(apply(clin_gt_15[clin_gt_15$RandomArm=="Olanzapine",10:13], 2, sd))
t1_means_df$sd_plac <- c(apply(clin_gt_15[clin_gt_15$RandomArm=="Placebo",10:13], 2, sd))
t1_means_df <- t1_means_df[,c(1,7,2,8,3:6)]

print(t1_means_df)

#write.csv(t1_means_df,file="/projects/loliver/STOPPD_Long_FC/results/t1_means_graphmets.csv")

```

```{r}
# table one with baseline values in the over 50 sample
CreateTableOne(data = clin_gt_15[clin_gt_15$age>50,c(6,9:13)],strata = c("RandomArm"))

# table one with baseline values in the 50 and under sample
CreateTableOne(data = clin_gt_15[clin_gt_15$age<=50,c(6,9:13)],strata = c("RandomArm"))

# age histogram for all participants
ggplot(clin_gt_15, aes(x = age)) + 
  geom_histogram(bins = 25, color = "black", fill = "grey") + 
  geom_vline(xintercept = 50) + 
  theme_minimal()

```

```{r}
# primary analyses - mixed linear model - graph metrics treatment x time in full group

# print full model outputs

# primary analyses - GE treatment x time in full group
all_ge <- clin_gt_15 %>%
    gather(oldcolname, ge, ge_t1, ge_t2) %>%
    mutate(model_days = if_else(oldcolname == "ge_t1", 1, dateDiff))

all_ge_lmer <- lmer(ge ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), data = all_ge)
summary(all_ge_lmer)

# primary analyses - CC treatment x time in full group
all_cc <- clin_gt_15 %>%
    gather(oldcolname, cc, cc_t1, cc_t2) %>%
    mutate(model_days = if_else(oldcolname == "cc_t1", 1, dateDiff))

all_cc_lmer <- lmer(cc ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), data = all_cc)
summary(all_cc_lmer)  

# transitivity treatment x time in full group
all_trans <- clin_gt_15 %>%
    gather(oldcolname, trans, trans_t1, trans_t2) %>%
    mutate(model_days = if_else(oldcolname == "trans_t1", 1, dateDiff))

all_trans_lmer <- lmer(trans ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), data = all_trans)
summary(all_trans_lmer)

# characteristic path length treatment x time in full group
all_cpl <- clin_gt_15 %>%
    gather(oldcolname, cpl, cpl_t1, cpl_t2) %>%
    mutate(model_days = if_else(oldcolname == "cpl_t1", 1, dateDiff))

all_cpl_lmer <- lmer(cpl ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), data = all_cpl)
summary(all_cpl_lmer)

# modularity treatment x time in full group
all_q <- clin_gt_15 %>%
    gather(oldcolname, q, q_t1, q_t2) %>%
    mutate(model_days = if_else(oldcolname == "q_t1", 1, dateDiff))

all_q_lmer <- lmer(q ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), data = all_q)
summary(all_q_lmer)

```

```{r}
# generate df with stats for treatment x time interaction 
trxti_df <- data.frame(rbind(summary(all_ge_lmer)[[10]][6,],summary(all_cc_lmer)[[10]][6,],summary(all_trans_lmer)[[10]][6,],summary(all_q_lmer)[[10]][6,]))
rownames(trxti_df) <- c("ge","cc","trans","mod")
colnames(trxti_df) <- c("beta","SE","df","t","p")

# add fdr-corrected p values and reorder columns 
trxti_df$p_fdr <- p.adjust(trxti_df$p, method = "fdr")
trxti_df <- trxti_df[,c(1,2,4,3,5,6)]

print(trxti_df)

#write.csv(trxti_df,file="/projects/loliver/STOPPD_Long_FC/results/treatxtime_graphmets.csv")

```

```{r}
# plot of change in GE treatment arm x time - all NS
ggplot(all_ge, aes(x=model_days, y=ge, fill = RandomArm)) + 
  geom_point(aes(shape = PlotLabel)) + 
  geom_line(aes(group=STUDYID, color = RandomArm), alpha = 0.5) + 
  geom_smooth(aes(color = RandomArm), method="lm", fill = "grey40") +
  labs(x ="Days between MRIs", 
       y = "Global Efficiency",
       shape = "Status at scan 2",
       color = "Group") +
  scale_colour_manual(values = RandomArmColors) +
  scale_fill_manual(values = RandomArmColors) +
  scale_shape_manual(values = c(21:23)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank())

# plot of change in CC treatment arm x time 
ggplot(all_cc, aes(x=model_days, y=cc, fill = RandomArm)) + 
  geom_point(aes(shape = PlotLabel)) + 
  geom_line(aes(group=STUDYID, color = RandomArm), alpha = 0.5) + 
  geom_smooth(aes(color = RandomArm), method="lm", fill = "grey40") +
  labs(x ="Days between MRIs", 
       y = "Clustering Coefficient",
       shape = "Status at scan 2",
       color = "Group") +
  scale_colour_manual(values = RandomArmColors) +
  scale_fill_manual(values = RandomArmColors) +
  scale_shape_manual(values = c(21:23)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank())

```

```{r}
# FDR correction for sig time finding
p.adjust(.0479, method = "fdr", n = 4)

```

```{r}
# sensitivity analysis excluding off protocol - GE # N=53
all_ge_sens1_lmer <- lmer(ge ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), data = all_ge[all_ge$ClinicalOutcome != "Off protocol",])
summary(all_ge_sens1_lmer)

all_cc_sens1_lmer <- lmer(cc ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), data = all_cc[all_cc$ClinicalOutcome != "Off protocol",])
summary(all_cc_sens1_lmer)

all_trans_sens1_lmer <- lmer(trans ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), data = all_trans[all_trans$ClinicalOutcome != "Off protocol",])
summary(all_trans_sens1_lmer)

all_q_sens1_lmer <- lmer(q ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), data = all_q[all_q$ClinicalOutcome != "Off protocol",])
summary(all_q_sens1_lmer)

```

```{r}
# generate df with stats for treatment x time interaction - sensitivity analysis 1
trxti_sens1_df <- data.frame(rbind(summary(all_ge_sens1_lmer)[[10]][6,],summary(all_cc_sens1_lmer)[[10]][6,],summary(all_trans_sens1_lmer)[[10]][6,],summary(all_q_sens1_lmer)[[10]][6,]))
rownames(trxti_sens1_df) <- c("ge","cc","trans","mod")
colnames(trxti_sens1_df) <- c("beta","SE","df","t","p")

# add fdr-corrected p values and reorder columns 
trxti_sens1_df$p_fdr <- p.adjust(trxti_sens1_df$p, method = "fdr")
trxti_sens1_df <- trxti_sens1_df[,c(1,2,4,3,5,6)]

print(trxti_sens1_df)

#write.csv(trxti_sens1_df,file="/projects/loliver/STOPPD_Long_FC/results/treatxtime_graphmets_sens_off_prot.csv")

```

```{r}
# sensitivity analysis for age > 50 - N=34
all_ge_sens2_lmer <- lmer(ge ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), data = all_ge[all_ge$age>50,])
summary(all_ge_sens2_lmer)

all_cc_sens2_lmer <- lmer(cc ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), data = all_cc[all_cc$age>50,])
summary(all_cc_sens2_lmer)

all_trans_sens2_lmer <- lmer(trans ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), data = all_trans[all_trans$age>50,])
summary(all_trans_sens2_lmer)

all_q_sens2_lmer <- lmer(q ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), data = all_q[all_q$age>50,])
summary(all_q_sens2_lmer)

```

```{r}
# generate df with stats for treatment x time interaction - sensitivity analysis 2
trxti_sens2_df <- data.frame(rbind(summary(all_ge_sens2_lmer)[[10]][6,],summary(all_cc_sens2_lmer)[[10]][6,],summary(all_trans_sens2_lmer)[[10]][6,],summary(all_q_sens2_lmer)[[10]][6,]))
rownames(trxti_sens2_df) <- c("ge","cc","trans","mod")
colnames(trxti_sens2_df) <- c("beta","SE","df","t","p")

# add fdr-corrected p values and reorder columns 
trxti_sens2_df$p_fdr <- p.adjust(trxti_sens2_df$p, method = "fdr")
trxti_sens2_df <- trxti_sens2_df[,c(1,2,4,3,5,6)]

print(trxti_sens2_df)

#write.csv(trxti_sens2_df,file="/projects/loliver/STOPPD_Long_FC/results/treatxtime_graphmets_sens_over50.csv")

```

```{r}
# sensitivity analysis for age <= 50 - N=24
all_ge_sens3_lmer <- lmer(ge ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), data = all_ge[all_ge$age<=50,])
summary(all_ge_sens3_lmer)

all_cc_sens3_lmer <- lmer(cc ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), data = all_cc[all_cc$age<=50,])
summary(all_cc_sens3_lmer)

all_trans_sens3_lmer <- lmer(trans ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), data = all_trans[all_trans$age<=50,])
summary(all_trans_sens3_lmer)

all_q_sens3_lmer <- lmer(q ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), data = all_q[all_q$age<=50,])
summary(all_q_sens3_lmer)

```

```{r}
# generate df with stats for treatment x time interaction - sensitivity analysis 3
trxti_sens3_df <- data.frame(rbind(summary(all_ge_sens3_lmer)[[10]][6,],summary(all_cc_sens3_lmer)[[10]][6,],summary(all_trans_sens3_lmer)[[10]][6,],summary(all_q_sens3_lmer)[[10]][6,]))
rownames(trxti_sens3_df) <- c("ge","cc","trans","mod")
colnames(trxti_sens3_df) <- c("beta","SE","df","t","p")

# add fdr-corrected p values and reorder columns 
trxti_sens3_df$p_fdr <- p.adjust(trxti_sens3_df$p, method = "fdr")
trxti_sens3_df <- trxti_sens3_df[,c(1,2,4,3,5,6)]

print(trxti_sens3_df)

#write.csv(trxti_sens3_df,file="/projects/loliver/STOPPD_Long_FC/results/treatxtime_graphmets_sens_50under.csv")

```

```{r}
# secondary analyses - graph metrics treatment in remitters only (sustained remission, discontinuers removed) # N=30
rem_gt_15 <- clin_gt_15 %>% filter(ClinicalOutcome == "Remission" & PlotLabel != "Discontinued") 

# global efficiency
rem_ge_lmer <- lmer(ge_diff ~ RandomArm + sex + age + (1|site), data = rem_gt_15)
summary(rem_ge_lmer)

# clustering coefficient
rem_cc_lmer <- lmer(cc_diff ~ RandomArm + sex + age + (1|site), data = rem_gt_15)
summary(rem_cc_lmer)

# trans
rem_trans_lmer <- lmer(trans_diff ~ RandomArm + sex + age + (1|site), data = rem_gt_15)
summary(rem_trans_lmer)

# Modularity (Q)
rem_q_lmer <- lmer(q_diff ~ RandomArm + sex + age + (1|site), data = rem_gt_15)
summary(rem_q_lmer)

# CPL
rem_cpl_lmer <- lmer(cpl_diff ~ RandomArm + sex + age + (1|site), data = rem_gt_15)
summary(rem_cpl_lmer)

```

```{r}
# generate df with stats for treatment 
rem_tr_df <- data.frame(rbind(summary(rem_ge_lmer)[[10]][2,],summary(rem_cc_lmer)[[10]][2,],summary(rem_trans_lmer)[[10]][2,],
                              summary(rem_q_lmer)[[10]][2,]))
rownames(rem_tr_df) <- c("ge_diff","cc_diff","trans_diff","mod_diff")
colnames(rem_tr_df) <- c("beta","SE","df","t","p")

# add fdr-corrected p values and reorder columns 
rem_tr_df$p_fdr <- p.adjust(rem_tr_df$p, method = "fdr")
rem_tr_df <- rem_tr_df[,c(1,2,4,3,5,6)]

print(rem_tr_df)

#write.csv(rem_tr_df,file="/projects/loliver/STOPPD_Long_FC/results/rem_tr_graphmets.csv")

```

```{r fig.height=4, fig.width=7}
# boxplot of difference in graph metrics (y axis) by RandomArm group (x axis) in remitters only

rem_gt_15 %>% 
  gather(gt_metric, change, ge_diff, cc_diff, trans_diff, q_diff) %>%
ggplot(aes(x= RandomArm, y = change, fill = RandomArm)) + 
     geom_boxplot(outlier.shape = NA, alpha = 0.0001) + 
     geom_dotplot(binaxis = 'y', stackdir = 'center') +
     geom_hline(yintercept = 0) +
     labs( x=NULL,      
           y = bquote('Change in Graph Metric'),
           fill = "Group") +
     scale_fill_manual(values = RandomArmColors) +
     scale_shape_manual(values = c(21)) +
     facet_wrap(~gt_metric) +
     theme_bw() +
     theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank())


# clustering coefficient only
ggplot(rem_gt_15, aes(x= RandomArm, y = ge_diff, fill = RandomArm)) + 
     geom_boxplot(outlier.shape = NA, alpha = 0.0001) + 
     geom_dotplot(binaxis = 'y', stackdir = 'center') +
     geom_hline(yintercept = 0) +
     labs( x=NULL,      
           y = bquote('Change in Global Efficiency'),
           fill = "Group") +
     scale_fill_manual(values = RandomArmColors) +
     scale_shape_manual(values = c(21)) +
 #    facet_wrap(~Region) + could use for densities
     theme_bw() +
     theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank())

```

```{r fig.height=4, fig.width=7}
# adding non-remitters to boxplot of difference boxplot of difference in graph metrics (y axis) by RandomArm group (x axis)

clin_gt_15 %>% 
  gather(gt_metric, change, ge_diff, cc_diff, trans_diff, q_diff) %>%
ggplot(aes(x= RandomArm, y = change, fill = ClinicalOutcome)) + 
     geom_boxplot(outlier.shape = NA) + 
     geom_dotplot(binaxis = 'y', stackdir = 'center', 
              position=position_dodge(0.8)) +
     geom_hline(yintercept = 0) +
     labs( x=NULL,      
           y = bquote('Change in Graph Metric')) +
     scale_fill_manual(values = c('white','grey70', "grey30")) +
     scale_shape_manual(values = c(21)) +
     facet_wrap(~gt_metric) +
     theme_bw() +
     theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank())

# clustering coefficient only
ggplot(clin_gt_15, aes(x= RandomArm, y = ge_diff, fill = ClinicalOutcome)) + 
  geom_boxplot(outlier.shape = NA) + 
  geom_dotplot(binaxis = 'y', stackdir = 'center', 
              position=position_dodge(0.8)) +
  geom_hline(yintercept = 0) +
  xlab(NULL) +
  ylab("Change in Global Efficiency Between Scans") +
  theme_bw() +
  scale_fill_manual(values = c('white','grey70', "grey30")) 

```

```{r}
# secondary sensitivity analysis excluding off protocol - no off protocol in remitter only sample

```

```{r}
# secondary sensitivity analyses for age > 50 - N=15

# global efficiency
rem_ge_sens2_lmer <- lmer(ge_diff ~ RandomArm + sex + age + (1|site), data = rem_gt_15[rem_gt_15$age>50,])
summary(rem_ge_sens2_lmer)

# clustering coefficient
rem_cc_sens2_lmer <- lmer(cc_diff ~ RandomArm + sex + age + (1|site), data = rem_gt_15[rem_gt_15$age>50,])
summary(rem_cc_sens2_lmer)

# trans
rem_trans_sens2_lmer <- lmer(trans_diff ~ RandomArm + sex + age + (1|site), data = rem_gt_15[rem_gt_15$age>50,])
summary(rem_trans_sens2_lmer)

# Modularity (Q)
rem_q_sens2_lmer <- lmer(q_diff ~ RandomArm + sex + age + (1|site), data = rem_gt_15[rem_gt_15$age>50,])
summary(rem_q_sens2_lmer)

# CPL
rem_cpl_sens2_lmer <- lmer(cpl_diff ~ RandomArm + sex + age + (1|site), data = rem_gt_15[rem_gt_15$age>50,])
summary(rem_cpl_sens2_lmer)

```

```{r}
# generate df with stats for treatment  - sensitivity analysis 2
rem_tr_sens2_df <- data.frame(rbind(summary(rem_ge_sens2_lmer)[[10]][2,],summary(rem_cc_sens2_lmer)[[10]][2,],summary(rem_trans_sens2_lmer)[[10]][2,],
                              summary(rem_q_sens2_lmer)[[10]][2,]))
rownames(rem_tr_sens2_df) <- c("ge_diff","cc_diff","trans_diff","mod_diff")
colnames(rem_tr_sens2_df) <- c("beta","SE","df","t","p")

# add fdr-corrected p values and reorder columns 
rem_tr_sens2_df$p_fdr <- p.adjust(rem_tr_sens2_df$p, method = "fdr")
rem_tr_sens2_df <- rem_tr_sens2_df[,c(1,2,4,3,5,6)]

print(rem_tr_sens2_df)

#write.csv(rem_tr_sens2_df,file="/projects/loliver/STOPPD_Long_FC/results/rem_tr_graphmets_sens_over50.csv")

```

```{r}
# secondary sensitivity analyses for age <= 50 - N=15

# global efficiency
rem_ge_sens3_lmer <- lmer(ge_diff ~ RandomArm + sex + age + (1|site), data = rem_gt_15[rem_gt_15$age<=50,])
summary(rem_ge_sens3_lmer)

# clustering coefficient
rem_cc_sens3_lmer <- lmer(cc_diff ~ RandomArm + sex + age + (1|site), data = rem_gt_15[rem_gt_15$age<=50,])
summary(rem_cc_sens3_lmer)

# trans
rem_trans_sens3_lmer <- lmer(trans_diff ~ RandomArm + sex + age + (1|site), data = rem_gt_15[rem_gt_15$age<=50,])
summary(rem_trans_sens3_lmer)

# Modularity (Q)
rem_q_sens3_lmer <- lmer(q_diff ~ RandomArm + sex + age + (1|site), data = rem_gt_15[rem_gt_15$age<=50,])
summary(rem_q_sens3_lmer)

# CPL
rem_cpl_sens3_lmer <- lmer(cpl_diff ~ RandomArm + sex + age + (1|site), data = rem_gt_15[rem_gt_15$age<=50,])
summary(rem_cpl_sens3_lmer)

```

```{r}
# generate df with stats for treatment - sensitivity analysis 3 
rem_tr_sens3_df <- data.frame(rbind(summary(rem_ge_sens3_lmer)[[10]][2,],summary(rem_cc_sens3_lmer)[[10]][2,],summary(rem_trans_sens3_lmer)[[10]][2,],
                              summary(rem_q_sens3_lmer)[[10]][2,]))
rownames(rem_tr_sens3_df) <- c("ge_diff","cc_diff","trans_diff","mod_diff")
colnames(rem_tr_sens3_df) <- c("beta","SE","df","t","p")

# add fdr-corrected p values and reorder columns 
rem_tr_sens3_df$p_fdr <- p.adjust(rem_tr_sens3_df$p, method = "fdr")
rem_tr_sens3_df <- rem_tr_sens3_df[,c(1,2,4,3,5,6)]

print(rem_tr_sens3_df)

#write.csv(rem_tr_sens3_df,file="/projects/loliver/STOPPD_Long_FC/results/rem_tr_graphmets_sens_50under.csv")

```


```{r}
# exploratory analysis - treatment in relapsers only # N=21
rel_gt_15 <- clin_gt_15 %>% filter(ClinicalOutcome == "Relapse") 

# global efficiency
rel_ge_lmer <- lmer(ge_diff ~ RandomArm + sex + age + (1|site), data = rel_gt_15)
summary(rel_ge_lmer)

# clustering coefficient
rel_cc_lmer <- lmer(cc_diff ~ RandomArm + sex + age + (1|site), data = rel_gt_15)
summary(rel_cc_lmer)

# trans
rel_trans_lmer <- lmer(trans_diff ~ RandomArm + sex + age + (1|site), data = rel_gt_15)
summary(rel_trans_lmer)

# Modularity (Q)
rel_q_lmer <- lmer(q_diff ~ RandomArm + sex + age + (1|site), data = rel_gt_15)
summary(rel_q_lmer)

# CPL
rel_cpl_lmer <- lmer(cpl_diff ~ RandomArm + sex + age + (1|site), data = rel_gt_15)
summary(rel_cpl_lmer)

```

```{r}
# generate df with stats for treatment - relapsers only 
rel_tr_df <- data.frame(rbind(summary(rel_ge_lmer)[[10]][2,],summary(rel_cc_lmer)[[10]][2,],summary(rel_trans_lmer)[[10]][2,],
                              summary(rel_q_lmer)[[10]][2,]))
rownames(rel_tr_df) <- c("ge_diff","cc_diff","trans_diff","mod_diff")
colnames(rel_tr_df) <- c("beta","SE","df","t","p")

# add fdr-corrected p values and reorder columns 
rel_tr_df$p_fdr <- p.adjust(rel_tr_df$p, method = "fdr")
rel_tr_df <- rel_tr_df[,c(1,2,4,3,5,6)]

print(rel_tr_df)

#write.csv(rel_tr_df,file="/projects/loliver/STOPPD_Long_FC/results/exp_rel_tr_graphmets.csv")

```

```{r}
# exploratory analysis - t-tests for diffs by clinical outcome in placebo only N=29 (11 remitters vs 18 relapsers)
plac_clin_gt_15 <- clin_gt_15[clin_gt_15$RandomArm=="Placebo" & (clin_gt_15$ClinicalOutcome=="Remission" | clin_gt_15$ClinicalOutcome=="Relapse"),]

for (i in colnames(plac_clin_gt_15[,20:23])) {
  print(i)
  t.test(get(i) ~ ClinicalOutcome, data = plac_clin_gt_15, paired=F) %>% print()
}

```

```{r}
# generate df with stats for placebo only
plac_df <- data.frame(matrix(NA, nrow = 4, ncol = 5))
rownames(plac_df) <- colnames(plac_clin_gt_15[,20:23])
colnames(plac_df) <- c("mean_rem","mean_rel","t","df","p")

for (i in colnames(plac_clin_gt_15[,20:23])) {
  plac_df[i,] <- c(tidy(t.test(get(i) ~ ClinicalOutcome, data = plac_clin_gt_15, paired=F))[,c("estimate1","estimate2","statistic","parameter","p.value")])
}

# add fdr-corrected p values 
plac_df$p_fdr <- p.adjust(plac_df$p, method = "fdr")

print(plac_df)

#write.csv(plac_df,file="/projects/loliver/STOPPD_Long_FC/results/exp_placebo_graphmets.csv")

```

```{r}
# exploratory analysis - t-tests for diffs by clinical outcome in olanzapine only N=24 (21 remitters vs 3 relapsers)
olan_clin_gt_15 <- clin_gt_15[clin_gt_15$RandomArm=="Olanzapine" & (clin_gt_15$ClinicalOutcome=="Remission" | clin_gt_15$ClinicalOutcome=="Relapse"),]

for (i in colnames(olan_clin_gt_15[,20:23])) {
  print(i)
  t.test(get(i) ~ ClinicalOutcome, data = olan_clin_gt_15, paired=F) %>% print()
}

```

```{r}
# generate df with stats for olanzapine only
olan_df <- data.frame(matrix(NA, nrow = 4, ncol = 5))
rownames(olan_df) <- colnames(olan_clin_gt_15[,20:23])
colnames(olan_df) <- c("mean_rem","mean_rel","t","df","p")

for (i in colnames(olan_clin_gt_15[,20:23])) {
  olan_df[i,] <- c(tidy(t.test(get(i) ~ ClinicalOutcome, data = olan_clin_gt_15, paired=F))[,c("estimate1","estimate2","statistic","parameter","p.value")])
}

# add fdr-corrected p values 
olan_df$p_fdr <- p.adjust(olan_df$p, method = "fdr")

print(olan_df)

#write.csv(olan_df,file="/projects/loliver/STOPPD_Long_FC/results/exp_olanzapine_graphmets.csv")

```

```{r}
# exploratory analysis - t-tests for diffs by clinical outcome across treatment groups N=53 (32 remitters vs 21 relapsers)
treat_clin_gt_15 <- clin_gt_15[clin_gt_15$ClinicalOutcome=="Remission" | clin_gt_15$ClinicalOutcome=="Relapse",]

for (i in colnames(treat_clin_gt_15[,20:23])) {
  print(i)
  t.test(get(i) ~ ClinicalOutcome, data = treat_clin_gt_15, paired=F) %>% print()
}

```

```{r}
# generate df with stats across treatment groups
treat_df <- data.frame(matrix(NA, nrow = 4, ncol = 5))
rownames(treat_df) <- colnames(treat_clin_gt_15[,20:23])
colnames(treat_df) <- c("mean_rem","mean_rel","t","df","p")

for (i in colnames(treat_clin_gt_15[,20:23])) {
  treat_df[i,] <- c(tidy(t.test(get(i) ~ ClinicalOutcome, data = treat_clin_gt_15, paired=F))[,c("estimate1","estimate2","statistic","parameter","p.value")])
}

# add fdr-corrected p values 
treat_df$p_fdr <- p.adjust(treat_df$p, method = "fdr")

print(treat_df)

#write.csv(treat_df,file="/projects/loliver/STOPPD_Long_FC/results/exp_acrosstreat_graphmets.csv")

```

```{r fig.height=4, fig.width=7}
# boxplot of difference in graph metrics (y axis) by clinical outcome group (x axis) across treatments

treat_clin_gt_15 %>% 
ggplot(aes(x= ClinicalOutcome, y = ge_diff, fill = ClinicalOutcome)) + 
     geom_boxplot(outlier.shape = NA, alpha = 0.0001) + 
     geom_dotplot(binaxis = 'y', stackdir = 'center') +
     geom_hline(yintercept = 0) +
     labs( x=NULL,      
           y = bquote('Change in Global Efficiency'),
           fill = "Group") +
     scale_fill_manual(values = c("springgreen1","mediumpurple1")) +
     scale_shape_manual(values = c(21)) +
     theme_bw() +
     theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank())

treat_clin_gt_15 %>% 
ggplot(aes(x = ClinicalOutcome, y = ge_diff, fill = RandomArm)) + 
     geom_boxplot(outlier.shape = NA, alpha = 0.0001) +
     geom_dotplot(binaxis = 'y', stackdir = 'center') +
     geom_hline(yintercept = 0) +
     labs( x=NULL,      
           y = bquote('Change in Global Efficiency'),
           fill = "Group") +
     scale_fill_manual(values = RandomArmColors) +
     scale_shape_manual(values = c(21)) +
     theme_bw() +
     theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank())

```

```{r}
# exploratory analysis - t-tests for diffs in remitters across treatment groups N=32
# mean diffs are t1-t2 (not intuitive; negative reflects an increase)
# ge
rem_ge_15 <- clin_gt_15[clin_gt_15$ClinicalOutcome=="Remission",] %>%
    gather(oldcolname, ge, ge_t1, ge_t2) %>%
    mutate(time = if_else(oldcolname == "ge_t1", "t1", "t2"))

rem_ge_time <- t.test(ge ~ time, data = rem_ge_15, paired=T)
print(rem_ge_time)

p.adjust(.0216,method="fdr",n=4)

# cc
rem_cc_15 <- clin_gt_15[clin_gt_15$ClinicalOutcome=="Remission",] %>%
    gather(oldcolname, cc, cc_t1, cc_t2) %>%
    mutate(time = if_else(oldcolname == "cc_t1", "t1", "t2"))

rem_cc_time <- t.test(cc ~ time, data = rem_cc_15, paired=T)
print(rem_cc_time)

# trans
rem_trans_15 <- clin_gt_15[clin_gt_15$ClinicalOutcome=="Remission",] %>%
    gather(oldcolname, trans, trans_t1, trans_t2) %>%
    mutate(time = if_else(oldcolname == "trans_t1", "t1", "t2"))

rem_trans_time <- t.test(trans ~ time, data = rem_trans_15, paired=T)
print(rem_trans_time)

# mod
rem_q_15 <- clin_gt_15[clin_gt_15$ClinicalOutcome=="Remission",] %>%
    gather(oldcolname, q, q_t1, q_t2) %>%
    mutate(time = if_else(oldcolname == "q_t1", "t1", "t2"))

rem_q_time <- t.test(q ~ time, data = rem_q_15, paired=T)
print(rem_q_time)

```

```{r}
# Plots for change in ge in remitters

rem_ge_15 %>% 
ggplot(aes(x= time, y = ge, fill = time)) + 
     geom_boxplot(outlier.shape = NA, alpha = 0.0001) + 
     geom_dotplot(binaxis = 'y', stackdir = 'center') +
     geom_hline(yintercept = 0) +
     labs( x=NULL,      
           y = bquote('Global Efficiency'),
           fill = "Group") +
     scale_fill_manual(values = c("springgreen1","mediumpurple1")) +
     scale_shape_manual(values = c(21)) +
     theme_bw() +
     theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank())

```

```{r}
# exploratory analysis - t-tests for diffs in relapsers across treatment groups N=21
# ge
rel_ge_15 <- clin_gt_15[clin_gt_15$ClinicalOutcome=="Relapse",] %>%
    gather(oldcolname, ge, ge_t1, ge_t2) %>%
    mutate(time = if_else(oldcolname == "ge_t1", "t1", "t2"))

rel_ge_time <- t.test(ge ~ time, data = rel_ge_15, paired=T)
print(rel_ge_time)

# cc
rel_cc_15 <- clin_gt_15[clin_gt_15$ClinicalOutcome=="Relapse",] %>%
    gather(oldcolname, cc, cc_t1, cc_t2) %>%
    mutate(time = if_else(oldcolname == "cc_t1", "t1", "t2"))

rel_cc_time <- t.test(cc ~ time, data = rel_cc_15, paired=T)
print(rel_cc_time)

# trans
rel_trans_15 <- clin_gt_15[clin_gt_15$ClinicalOutcome=="Relapse",] %>%
    gather(oldcolname, trans, trans_t1, trans_t2) %>%
    mutate(time = if_else(oldcolname == "trans_t1", "t1", "t2"))

rel_trans_time <- t.test(trans ~ time, data = rel_trans_15, paired=T)
print(rel_trans_time)

# mod
rel_q_15 <- clin_gt_15[clin_gt_15$ClinicalOutcome=="Relapse",] %>%
    gather(oldcolname, q, q_t1, q_t2) %>%
    mutate(time = if_else(oldcolname == "q_t1", "t1", "t2"))

rel_q_time <- t.test(q ~ time, data = rel_q_15, paired=T)
print(rel_q_time)

```

```{r}
# generate df with stats for treatment x time interaction  ### not updated ###
trxti_df <- data.frame(rbind(summary(all_ge_lmer)[[10]][6,],summary(all_cc_lmer)[[10]][6,],summary(all_trans_lmer)[[10]][6,],summary(all_q_lmer)[[10]][6,]))
rownames(trxti_df) <- c("ge","cc","trans","mod")
colnames(trxti_df) <- c("beta","SE","df","t","p")

# add fdr-corrected p values and reorder columns 
trxti_df$p_fdr <- p.adjust(trxti_df$p, method = "fdr")
trxti_df <- trxti_df[,c(1,2,4,3,5,6)]

print(trxti_df)

#write.csv(trxti_df,file="/projects/loliver/STOPPD_Long_FC/results/treatxtime_graphmets.csv")

```


Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.