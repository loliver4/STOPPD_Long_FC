---
title: "STOPPD Longitudinal rsFC"
output: html_notebook
---

# Generate connectivity matrices for STOP-PD longitudinal functional connectivity analyses 


```{r, message=FALSE, warning=FALSE, results=FALSE}
library(splitstackshape)
library(tidyr)
library(dplyr)
library(corrr)
library(psych)
library(tableone)
library(corrplot)
library(ggplot2)

```

```{r, warning=FALSE, results=FALSE}
# set working dir
setwd("/projects/loliver/STOPPD_Long_FC/data/processed")

# find baseline RS time series files  # pattern glob2rx("sub-?????????_ses-01_run-*_RS_2mm_glasser_tian_meants.csv")
# subject IDs with 10 characters are for control repeat/longitudinal scans (extra R in the ID)
files_RS_ts1 <- list.files(path= ".", recursive=T, full.names=F, pattern="^sub-........._ses-01_run-.*_RS_2mm_glasser_tian_meants\\.csv$")

# confirm csvs aren't empty
files_RS_ts1[file.size(files_RS_ts1) == 0]

# create list of IDs
ptlist1 <- substring(files_RS_ts1,8,13)

# read in time series files
RS_ts1 <- lapply(files_RS_ts1, read.csv, header=F)

# transpose dfs
RS_ts1 <- lapply(RS_ts1, t)

# Name dfs with participant IDs
names(RS_ts1) <- ptlist1

```

```{r, warning=FALSE, results=FALSE}
# set working dir
setwd("/projects/loliver/STOPPD_Long_FC/data/processed")

# find longitudinal RS time series files  # pattern glob2rx("sub-?????????_ses-02_run-*_RS_2mm_glasser_tian_meants.csv")
# subject IDs with 10 characters are for control repeat/longitudinal scans (extra R in the ID)
files_RS_ts2 <- list.files(path= ".", recursive=T, full.names=F, pattern="^sub-........._ses-02_run-.*_RS_2mm_glasser_tian_meants\\.csv$")

# confirm csvs aren't empty
files_RS_ts2[file.size(files_RS_ts2) == 0]

# create list of IDs
ptlist2 <- substring(files_RS_ts2,8,13)

# read in time series files
RS_ts2 <- lapply(files_RS_ts2, read.csv, header=F)

# transpose dfs
RS_ts2 <- lapply(RS_ts2, t)

# Name dfs with participant IDs
names(RS_ts2) <- ptlist2


# keep only those with both baseline and longitudinal data - not actually necessary atm
#RS_ts1 <- RS_ts1[names(RS_ts1) %in% names(RS_ts2)]

```

```{r}
# read in clinical data for those who passed imaging QC (as per /projects/loliver/STOPPD_Long_FC/data/raw/stoppd_usable_rsFC_sublist_Nick.csv)
# original csv generated by Erin for the JAMA Psych paper
stpd_clin <- read.csv(file = "/projects/loliver/STOPPD_Long_FC/data/raw/STOPPD_clinical_fc.csv", header=T) %>%
  mutate(STUDYID = as.character(STUDYID),
         dateDiff = as.numeric(dateDiff),
         site = as.factor(site),
         RandomArm = factor(randomization, 
                           levels = c("O", "P"), labels = c("Olanzapine", "Placebo")),
         sex = factor(sex, levels = c("M", "F"), labels = c("Male", "Female")),
         ClinicalOutcome = factor(ClinicalOutcome, 
                             levels = c("Remission","Relapse", "Off protocol")),
         PlotLabel = factor(PlotLabel, 
                       levels = c("Sustained Remisson","Relapse", "Discontinued_Remission"),
                       labels = c("Sustained Remisson","Relapse", "Discontinued"))) 


# exclude 210012 (116 TRs vs 206), 210013 (116 TRs), 220002 (116 TRs), and 320006 (146 TRs) due to incomplete RS ses-01 data
# 220002 also has incomplete RS ses-02 data (116 TRs)  
stpd_clin <- stpd_clin[stpd_clin$STUDYID!="210012" & stpd_clin$STUDYID!="210013" & stpd_clin$STUDYID!="220002" & stpd_clin$STUDYID!="320006",]

# exclude 410012 and 320032 due to intracranial findings
stpd_clin <- stpd_clin[stpd_clin$STUDYID!="410012" & stpd_clin$STUDYID!="320032",]

# keep conn data for eligible participants who passed QC
RS_ts1 <- RS_ts1[names(RS_ts1) %in% stpd_clin$STUDYID]
RS_ts2 <- RS_ts2[names(RS_ts2) %in% stpd_clin$STUDYID]

# identify participant with missing conn data - sub-CMH420018 was missing fmriprep func data for ses-01 in the archive, but this exists now
stpd_clin[!(stpd_clin$STUDYID %in% names(RS_ts1)),]

# read in Tian and Glasser ROI labels (392)
rois <- read.csv(file = "/projects/loliver/STOPPD_Long_FC/data/raw/Glasser_Tian_roi_info.csv", header=T)

```

```{r}
# generate baseline correlation matrices for each participant
cor_rs1  <- lapply(RS_ts1, cor)

# fisher z transform corrs to normalize dist
cor_rs1_z  <- lapply(cor_rs1, fisherz)

# add ROI names and replace inf values with 0 (diagonals set to zero when thresholding in matlab anyway)
for (i in names(cor_rs1_z)) {
  colnames(cor_rs1_z[[i]]) <- as.vector(rois$atlas_roi)
  rownames(cor_rs1_z[[i]]) <- as.vector(rois$atlas_roi)
  cor_rs1_z[[i]][is.infinite(cor_rs1_z[[i]])] <- 0
}

# check out negative values - about 50% negative (total length: 153664; keep in mind GSR applied)
for (i in names(cor_rs1_z)){
  print((length(cor_rs1_z[[i]][cor_rs1_z[[i]]<0])))
  print(summary(cor_rs1_z[[i]][cor_rs1_z[[i]]<0]))
}

# check for NAs - none
for (i in names(cor_rs1_z)){
  print(cor_rs1_z[[i]][is.na(cor_rs1_z[[i]])])
}

# cortical ROIs only
cor_rs1_z_cort <- lapply(cor_rs1_z, "[", 33:392, 33:392)

# subcortical ROIs only
cor_rs1_z_sub <- lapply(cor_rs1_z, "[", 1:32, 1:32)

# write unthresholded individual conn matrices for use in matlab (BCT) 
#setwd("/projects/loliver/STOPPD_Long_FC/data/processed/conn_matrices/full/ses-01")

#for (i in names(cor_rs1_z)) {
#  write.table(cor_rs1_z[[i]],file=paste0(i,"_whole.csv"),row.names = F,col.names = F,sep=",")   
#}

# cortical ROIs only
#for (i in names(cor_rs1_z_cort)) {
#  write.table(cor_rs1_z_cort[[i]],file=paste0(i,"_cortical.csv"),row.names = F,col.names = F,sep=",")   
#}

# subcortical ROIs only
#for (i in names(cor_rs1_z_sub)) {
#  write.table(cor_rs1_z_sub[[i]],file=paste0(i,"_subcortical.csv"),row.names = F,col.names = F,sep=",")     
#}

```

```{r}
# generate longitudinal correlation matrices for each participant
cor_rs2  <- lapply(RS_ts2, cor)

# fisher z transform corrs to normalize dist
cor_rs2_z  <- lapply(cor_rs2, fisherz)

# add ROI names and replace inf values with 0 (diagonals set to zero when thresholding in matlab anyway)
for (i in names(cor_rs2_z)) {
  colnames(cor_rs2_z[[i]]) <- as.vector(rois$atlas_roi)
  rownames(cor_rs2_z[[i]]) <- as.vector(rois$atlas_roi)
  cor_rs2_z[[i]][is.infinite(cor_rs2_z[[i]])] <- 0
}

# check out negative values - about 50% negative (total length: 153664; keep in mind GSR applied)
for (i in names(cor_rs2_z)){
  print((length(cor_rs2_z[[i]][cor_rs2_z[[i]]<0])))
  print(summary(cor_rs2_z[[i]][cor_rs2_z[[i]]<0]))
}

# check for NAs - none
for (i in names(cor_rs2_z)){
  print(cor_rs2_z[[i]][is.na(cor_rs2_z[[i]])])
}

# cortical ROIs only
cor_rs2_z_cort <- lapply(cor_rs2_z, "[", 33:392, 33:392)

# subcortical ROIs only
cor_rs2_z_sub <- lapply(cor_rs2_z, "[", 1:32, 1:32)

# write unthresholded individual conn matrices for use in matlab (BCT) 
#setwd("/projects/loliver/STOPPD_Long_FC/data/processed/conn_matrices/full/ses-02")

#for (i in names(cor_rs2_z)) {
#  write.table(cor_rs2_z[[i]],file=paste0(i,"_whole.csv"),row.names = F,col.names = F,sep=",")   
#}

# cortical ROIs only
#for (i in names(cor_rs2_z_cort)) {
#  write.table(cor_rs2_z_cort[[i]],file=paste0(i,"_cortical.csv"),row.names = F,col.names = F,sep=",")   
#}

# subcortical ROIs only
#for (i in names(cor_rs2_z_sub)) {
#  write.table(cor_rs2_z_sub[[i]],file=paste0(i,"_subcortical.csv"),row.names = F,col.names = F,sep=",")     
#}

```



When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
