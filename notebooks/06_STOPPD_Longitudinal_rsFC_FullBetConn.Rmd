---
title: "STOPPD_Longitudinal_rsFC_FullBetConn"
output: html_notebook
---

# STOP-PD functional analyses for connectivity between the secondary visual network and each of the other networks

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r, message=FALSE, warning=FALSE, results=FALSE}
library(splitstackshape)
library(tidyr)
library(dplyr)
library(corrr)
library(psych)
library(tableone)
library(corrplot)
library(ggplot2)
library(lme4)
library(lmerTest)
library(broom)

```

```{r, warning=FALSE, results=FALSE}
# set working dir
setwd("/projects/loliver/STOPPD_Long_FC/data/processed")

# find baseline RS time series files  # pattern glob2rx("sub-?????????_ses-01_run-*_RS_2mm_glasser_tian_meants.csv")
# subject IDs with 10 characters are for control repeat/longitudinal scans (extra R in the ID)
files_RS_ts1 <- list.files(path= ".", recursive=T, full.names=F, pattern="^sub-........._ses-01_run-.*_RS_2mm_glasser_tian_meants\\.csv$")

# confirm csvs aren't empty
files_RS_ts1[file.size(files_RS_ts1) == 0]

# create list of IDs
ptlist1 <- substring(files_RS_ts1,8,13)

# read in time series files
RS_ts1 <- lapply(files_RS_ts1, read.csv, header=F)

# transpose dfs
RS_ts1 <- lapply(RS_ts1, t)

# Name dfs with participant IDs
names(RS_ts1) <- ptlist1

```
```{r, warning=FALSE, results=FALSE}
# set working dir
setwd("/projects/loliver/STOPPD_Long_FC/data/processed")

# find patient longitudinal RS time series files  # pattern glob2rx("sub-?????????_ses-02_run-*_RS_2mm_glasser_tian_meants.csv")
# subject IDs with 10 characters are for control repeat/longitudinal scans (extra R in the ID)
files_RS_ts2 <- list.files(path= ".", recursive=T, full.names=F, pattern="^sub-........._ses-02_run-.*_RS_2mm_glasser_tian_meants\\.csv$")

# confirm csvs aren't empty
files_RS_ts2[file.size(files_RS_ts2) == 0]

# create list of IDs
ptlist2 <- substring(files_RS_ts2,8,13)

# read in time series files
RS_ts2 <- lapply(files_RS_ts2, read.csv, header=F)

# transpose dfs
RS_ts2 <- lapply(RS_ts2, t)

# Name dfs with participant IDs
names(RS_ts2) <- ptlist2


# keep only those with both baseline and longitudinal data - not actually necessary atm
#RS_ts1 <- RS_ts1[names(RS_ts1) %in% names(RS_ts2)]

```

```{r}
# read in clinical data for those who passed imaging QC (as per /projects/loliver/STOPPD_Long_FC/data/raw/stoppd_usable_rsFC_sublist_Nick.csv)
# original csv generated by Erin for the JAMA Psych paper
stpd_clin <- read.csv(file = "/projects/loliver/STOPPD_Long_FC/data/raw/STOPPD_clinical_fc.csv", header=T) %>%
  mutate(STUDYID = as.character(STUDYID),
         dateDiff = as.numeric(dateDiff),
         site = as.factor(site),
         RandomArm = factor(randomization, 
                           levels = c("O", "P"), labels = c("Olanzapine", "Placebo")),
         sex = factor(sex, levels = c("M", "F"), labels = c("Male", "Female")),
         ClinicalOutcome = factor(ClinicalOutcome, 
                             levels = c("Remission","Relapse", "Off protocol")),
         PlotLabel = factor(PlotLabel, 
                       levels = c("Sustained Remisson","Relapse", "Discontinued_Remission"),
                       labels = c("Sustained Remisson","Relapse", "Discontinued"))) 

# drop added hamd scores so as not to interfere with for loops below
stpd_clin <- stpd_clin[,c(1:8,12)]

# exclude 210012 (116 TRs vs 206), 210013 (116 TRs), 220002 (116 TRs), and 320006 (146 TRs) due to incomplete RS ses-01 data
# 220002 also has incomplete RS ses-02 data (116 TRs)  
stpd_clin <- stpd_clin[stpd_clin$STUDYID!="210012" & stpd_clin$STUDYID!="210013" & stpd_clin$STUDYID!="220002" & stpd_clin$STUDYID!="320006",]

# exclude 410012 and 320032 due to intracranial findings
stpd_clin <- stpd_clin[stpd_clin$STUDYID!="410012" & stpd_clin$STUDYID!="320032",]

# identify participant with missing conn data - sub-CMH420018 was missing fmriprep func data for ses-01 in the archive, but this exists now
stpd_clin[!(stpd_clin$STUDYID %in% names(RS_ts1)),]

# write out csv for current sample
#write.csv(stpd_clin,file="/projects/loliver/STOPPD_Long_FC/data/processed/behavioural/STOPPD_clinical_fc.csv", row.names=F)

```

```{r}
# keep conn data for eligible participants who passed QC
RS_ts1 <- RS_ts1[names(RS_ts1) %in% stpd_clin$STUDYID]
RS_ts2 <- RS_ts2[names(RS_ts2) %in% stpd_clin$STUDYID]

```

```{r}
# calculate avg activation across networks for between-network connectivity
# read in Tian and Glasser ROI labels (392)
rois <- read.csv(file = "/projects/loliver/STOPPD_Long_FC/data/raw/Glasser_Tian_roi_info.csv", header=T)

# add ROIs as colnames 
for (i in names(RS_ts1)) {
  colnames(RS_ts1[[i]]) <- as.vector(rois$atlas_roi)
}

# calculate avg activation across networks for each participant
RS_nets_ts1 <- list()

for (i in names(RS_ts1)) {
  RS_nets_ts1[[i]] <- data.frame(matrix(NA, nrow = 206, ncol = 1))[-1]
  RS_nets_ts1[[i]][,"Vis1_t1"] <- rowMeans(RS_ts1[[i]][, colnames(RS_ts1[[i]]) %in% (rois[rois$net_ColeAnt=="Visual1","atlas_roi"])])
  RS_nets_ts1[[i]][,"Vis2_t1"] <- rowMeans(RS_ts1[[i]][, colnames(RS_ts1[[i]]) %in% (rois[rois$net_ColeAnt=="Visual2","atlas_roi"])])  
  RS_nets_ts1[[i]][,"SM_t1"] <- rowMeans(RS_ts1[[i]][, colnames(RS_ts1[[i]]) %in% (rois[rois$net_ColeAnt=="Somatomotor","atlas_roi"])])
  RS_nets_ts1[[i]][,"CiOp_t1"] <- rowMeans(RS_ts1[[i]][, colnames(RS_ts1[[i]]) %in% (rois[rois$net_ColeAnt=="Cingulo-Opercular","atlas_roi"])])
  RS_nets_ts1[[i]][,"DAtt_t1"] <- rowMeans(RS_ts1[[i]][, colnames(RS_ts1[[i]]) %in% (rois[rois$net_ColeAnt=="Dorsal-Attention","atlas_roi"])])
  RS_nets_ts1[[i]][,"Lang_t1"] <- rowMeans(RS_ts1[[i]][, colnames(RS_ts1[[i]]) %in% (rois[rois$net_ColeAnt=="Language","atlas_roi"])])
  RS_nets_ts1[[i]][,"FrPr_t1"] <- rowMeans(RS_ts1[[i]][, colnames(RS_ts1[[i]]) %in% (rois[rois$net_ColeAnt=="Frontoparietal","atlas_roi"])])
  RS_nets_ts1[[i]][,"Aud_t1"] <- rowMeans(RS_ts1[[i]][, colnames(RS_ts1[[i]]) %in% (rois[rois$net_ColeAnt=="Auditory","atlas_roi"])])
  RS_nets_ts1[[i]][,"DMN_t1"] <- rowMeans(RS_ts1[[i]][, colnames(RS_ts1[[i]]) %in% (rois[rois$net_ColeAnt=="Default","atlas_roi"])]) 
  RS_nets_ts1[[i]][,"Post_Mult_t1"] <- rowMeans(RS_ts1[[i]][, colnames(RS_ts1[[i]]) %in% (rois[rois$net_ColeAnt=="Posterior-Multimodal","atlas_roi"])])
  RS_nets_ts1[[i]][,"Vent_Mult_t1"] <- rowMeans(RS_ts1[[i]][, colnames(RS_ts1[[i]]) %in% (rois[rois$net_ColeAnt=="Ventral-Multimodal","atlas_roi"])])
  RS_nets_ts1[[i]][,"Orb_Aff_t1"] <- rowMeans(RS_ts1[[i]][, colnames(RS_ts1[[i]]) %in% (rois[rois$net_ColeAnt=="Orbito-Affective","atlas_roi"])])
  RS_nets_ts1[[i]][,"Sub_t1"] <- rowMeans(RS_ts1[[i]][, colnames(RS_ts1[[i]]) %in% (rois[rois$net_ColeAnt=="Subcortical","atlas_roi"])])
}

net_labels_t1 <- c("Vis1_t1","Vis2_t1","SM_t1","CiOp_t1","DAtt_t1","Lang_t1","FrPr_t1","Aud_t1","DMN_t1","Post_Mult_t1","Vent_Mult_t1","Orb_Aff_t1","Sub_t1")

```

```{r}
# generate between-network correlation matrices for each participant
cor_nets_rs1 <- lapply(RS_nets_ts1, correlate)

# set upper triangle to NA
cor_nets_rs1 <- lapply(cor_nets_rs1, shave)

# example corr plot
# rplot(cor_nets_rs1[[1]])

# create dfs with corrs for each participant
cor_nets_rs1_str <- lapply(cor_nets_rs1, stretch, na.rm=F)
cor_nets_rs1_stru <- lapply(cor_nets_rs1_str, unite, col="rois", 1:2, sep="-", remove=T)
cor_nets_rs1_df <- lapply(cor_nets_rs1_stru, data.frame)

# change col 1 to row names
cor_names_rs1 <- as.vector(cor_nets_rs1_df[[1]][,1])

for (i in names(cor_nets_rs1_df)) {
  cor_nets_rs1_df[[i]] <- data.frame(cor_nets_rs1_df[[i]][,2])
  cor_nets_rs1_df[[i]] <- t(cor_nets_rs1_df[[i]])
  colnames(cor_nets_rs1_df[[i]]) <- cor_names_rs1
}

# bind rows across df list to generate df with between network corrs for each participant
mean_bet_conn_t1 <- data.frame(do.call("rbind",cor_nets_rs1_df))
rownames(mean_bet_conn_t1) <- names(cor_nets_rs1_df)

# remove columns with only NAs
mean_bet_conn_t1 <- mean_bet_conn_t1[,colSums(is.na(mean_bet_conn_t1)) != nrow(mean_bet_conn_t1)]

# fisher z transform corrs and add ID column
mean_bet_conn_t1  <- fisherz(mean_bet_conn_t1)
mean_bet_conn_t1$STUDYID <- rownames(mean_bet_conn_t1)
mean_bet_conn_t1 <- mean_bet_conn_t1[,c(79,1:78)]

```

```{r}
# generate baseline correlation matrices for each participant for within-network conn
cor_rs1  <- lapply(RS_ts1, cor)

# fisher z transform corrs to normalize dist
cor_rs1_z  <- lapply(cor_rs1, fisherz)

# add ROI names and replace inf values with NA for mean calculations 
for (i in names(cor_rs1_z)) {
  colnames(cor_rs1_z[[i]]) <- as.vector(rois$atlas_roi)
  rownames(cor_rs1_z[[i]]) <- as.vector(rois$atlas_roi)
  cor_rs1_z[[i]][is.infinite(cor_rs1_z[[i]])] <- NA
}

# mean within network corrs
mean_net_conn_t1 <- data.frame()

for (i in names(cor_rs1_z)) {
  mean_net_conn_t1[i,"Sub_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Subcortical","atlas_roi"]), colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Subcortical","atlas_roi"])],na.rm=T)
  mean_net_conn_t1[i,"SM_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Somatomotor","atlas_roi"]), colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Somatomotor","atlas_roi"])],na.rm=T)
  mean_net_conn_t1[i,"CiOp_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Cingulo-Opercular","atlas_roi"]), colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Cingulo-Opercular","atlas_roi"])],na.rm=T)
  mean_net_conn_t1[i,"FrPr_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Frontoparietal","atlas_roi"]), colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Frontoparietal","atlas_roi"])],na.rm=T)
  mean_net_conn_t1[i,"DMN_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Default","atlas_roi"]), colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Default","atlas_roi"])],na.rm=T)
  mean_net_conn_t1[i,"Vis1_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual1","atlas_roi"]), colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual1","atlas_roi"])],na.rm=T)
  mean_net_conn_t1[i,"Vis2_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual2","atlas_roi"]), colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual2","atlas_roi"])],na.rm=T)
  mean_net_conn_t1[i,"DAtt_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Dorsal-Attention","atlas_roi"]), colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Dorsal-Attention","atlas_roi"])],na.rm=T)
  mean_net_conn_t1[i,"Lang_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Language","atlas_roi"]), colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Language","atlas_roi"])],na.rm=T)
  mean_net_conn_t1[i,"Aud_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Auditory","atlas_roi"]), colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Auditory","atlas_roi"])],na.rm=T)
  mean_net_conn_t1[i,"Post_Mult_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Posterior-Multimodal","atlas_roi"]), colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Posterior-Multimodal","atlas_roi"])],na.rm=T)
  mean_net_conn_t1[i,"Vent_Mult_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Ventral-Multimodal","atlas_roi"]), colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Ventral-Multimodal","atlas_roi"])],na.rm=T)
  mean_net_conn_t1[i,"Orb_Aff_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Orbito-Affective","atlas_roi"]), colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Orbito-Affective","atlas_roi"])],na.rm=T)
  mean_net_conn_t1[i,"Bet_Sub_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Subcortical","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_SM_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Somatomotor","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Somatomotor","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_CiOp_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Cingulo-Opercular","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Cingulo-Opercular","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_FrPr_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Frontoparietal","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Frontoparietal","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_DMN_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Default","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Default","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_Vis1_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual1","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual1","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_Vis2_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual2","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual2","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_DAtt_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Dorsal-Attention","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Dorsal-Attention","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_Lang_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Language","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Language","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_Aud_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Auditory","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Auditory","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_Post_Mult_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Posterior-Multimodal","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Posterior-Multimodal","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_Vent_Mult_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Ventral-Multimodal","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Ventral-Multimodal","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_Orb_Aff_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Orbito-Affective","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Orbito-Affective","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_SM_Cort_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Somatomotor","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Somatomotor"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_CiOp_Cort_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Cingulo-Opercular","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Cingulo-Opercular"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_FrPr_Cort_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Frontoparietal","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Frontoparietal"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_DMN_Cort_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Default","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Default"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_Vis1_Cort_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual1","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual1"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_Vis2_Cort_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual2","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual2"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_DAtt_Cort_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Dorsal-Attention","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Dorsal-Attention"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_Lang_Cort_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Language","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Language"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_Aud_Cort_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Auditory","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Auditory"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_Post_Mult_Cort_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Posterior-Multimodal","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Posterior-Multimodal"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_Vent_Mult_Cort_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Ventral-Multimodal","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Ventral-Multimodal"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_Orb_Aff_Cort_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Orbito-Affective","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Orbito-Affective"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
} 

mean_net_conn_t1$STUDYID <- rownames(mean_net_conn_t1)
mean_net_conn_t1 <- mean_net_conn_t1[,c(39,1:38)]

```

```{r}
# calculate avg activation across networks for between-network connectivity - longitudinal data
# add ROIs as colnames 
for (i in names(RS_ts2)) {
  colnames(RS_ts2[[i]]) <- as.vector(rois$atlas_roi)
}

# calculate avg activation across networks for each participant
RS_nets_ts2 <- list()

for (i in names(RS_ts2)) {
  RS_nets_ts2[[i]] <- data.frame(matrix(NA, nrow = 206, ncol = 1))[-1]
  RS_nets_ts2[[i]][,"Vis1_t2"] <- rowMeans(RS_ts2[[i]][, colnames(RS_ts2[[i]]) %in% (rois[rois$net_ColeAnt=="Visual1","atlas_roi"])])
  RS_nets_ts2[[i]][,"Vis2_t2"] <- rowMeans(RS_ts2[[i]][, colnames(RS_ts2[[i]]) %in% (rois[rois$net_ColeAnt=="Visual2","atlas_roi"])])  
  RS_nets_ts2[[i]][,"SM_t2"] <- rowMeans(RS_ts2[[i]][, colnames(RS_ts2[[i]]) %in% (rois[rois$net_ColeAnt=="Somatomotor","atlas_roi"])])
  RS_nets_ts2[[i]][,"CiOp_t2"] <- rowMeans(RS_ts2[[i]][, colnames(RS_ts2[[i]]) %in% (rois[rois$net_ColeAnt=="Cingulo-Opercular","atlas_roi"])])
  RS_nets_ts2[[i]][,"DAtt_t2"] <- rowMeans(RS_ts2[[i]][, colnames(RS_ts2[[i]]) %in% (rois[rois$net_ColeAnt=="Dorsal-Attention","atlas_roi"])])
  RS_nets_ts2[[i]][,"Lang_t2"] <- rowMeans(RS_ts2[[i]][, colnames(RS_ts2[[i]]) %in% (rois[rois$net_ColeAnt=="Language","atlas_roi"])])
  RS_nets_ts2[[i]][,"FrPr_t2"] <- rowMeans(RS_ts2[[i]][, colnames(RS_ts2[[i]]) %in% (rois[rois$net_ColeAnt=="Frontoparietal","atlas_roi"])])
  RS_nets_ts2[[i]][,"Aud_t2"] <- rowMeans(RS_ts2[[i]][, colnames(RS_ts2[[i]]) %in% (rois[rois$net_ColeAnt=="Auditory","atlas_roi"])])
  RS_nets_ts2[[i]][,"DMN_t2"] <- rowMeans(RS_ts2[[i]][, colnames(RS_ts2[[i]]) %in% (rois[rois$net_ColeAnt=="Default","atlas_roi"])]) 
  RS_nets_ts2[[i]][,"Post_Mult_t2"] <- rowMeans(RS_ts2[[i]][, colnames(RS_ts2[[i]]) %in% (rois[rois$net_ColeAnt=="Posterior-Multimodal","atlas_roi"])])
  RS_nets_ts2[[i]][,"Vent_Mult_t2"] <- rowMeans(RS_ts2[[i]][, colnames(RS_ts2[[i]]) %in% (rois[rois$net_ColeAnt=="Ventral-Multimodal","atlas_roi"])])
  RS_nets_ts2[[i]][,"Orb_Aff_t2"] <- rowMeans(RS_ts2[[i]][, colnames(RS_ts2[[i]]) %in% (rois[rois$net_ColeAnt=="Orbito-Affective","atlas_roi"])])
  RS_nets_ts2[[i]][,"Sub_t2"] <- rowMeans(RS_ts2[[i]][, colnames(RS_ts2[[i]]) %in% (rois[rois$net_ColeAnt=="Subcortical","atlas_roi"])])
}

net_labels_t2 <- c("Vis1_t2","Vis2_t2","SM_t2","CiOp_t2","DAtt_t2","Lang_t2","FrPr_t2","Aud_t2","DMN_t2","Post_Mult_t2","Vent_Mult_t2","Orb_Aff_t2","Sub_t2")

```

```{r}
# generate between-network correlation matrices for each participant - longitudinal data
cor_nets_rs2 <- lapply(RS_nets_ts2, correlate)

# set upper triangle to NA
cor_nets_rs2 <- lapply(cor_nets_rs2, shave)

# example corr plot
# rplot(cor_nets_rs2[[1]])

# create dfs with corrs for each participant
cor_nets_rs2_str <- lapply(cor_nets_rs2, stretch, na.rm=F)
cor_nets_rs2_stru <- lapply(cor_nets_rs2_str, unite, col="rois", 1:2, sep="-", remove=T)
cor_nets_rs2_df <- lapply(cor_nets_rs2_stru, data.frame)

# change col 1 to row names
cor_names_rs2 <- as.vector(cor_nets_rs2_df[[1]][,1])

for (i in names(cor_nets_rs2_df)) {
  cor_nets_rs2_df[[i]] <- data.frame(cor_nets_rs2_df[[i]][,2])
  cor_nets_rs2_df[[i]] <- t(cor_nets_rs2_df[[i]])
  colnames(cor_nets_rs2_df[[i]]) <- cor_names_rs2
}

# bind rows across df list to generate df with between network corrs for each participant
mean_bet_conn_t2 <- data.frame(do.call("rbind",cor_nets_rs2_df))
rownames(mean_bet_conn_t2) <- names(cor_nets_rs2_df)

# remove columns with only NAs
mean_bet_conn_t2 <- mean_bet_conn_t2[,colSums(is.na(mean_bet_conn_t2)) != nrow(mean_bet_conn_t2)]

# fisher z transform corrs and add ID column
mean_bet_conn_t2  <- fisherz(mean_bet_conn_t2)
mean_bet_conn_t2$STUDYID <- rownames(mean_bet_conn_t2)
mean_bet_conn_t2 <- mean_bet_conn_t2[,c(79,1:78)]

```

```{r}
# generate longitudinal correlation matrices for each participant for within-network conn
cor_rs2  <- lapply(RS_ts2, cor)

# fisher z transform corrs to normalize dist
cor_rs2_z  <- lapply(cor_rs2, fisherz)

# add ROI names and replace inf values with NA for mean calculations 
for (i in names(cor_rs2_z)) {
  colnames(cor_rs2_z[[i]]) <- as.vector(rois$atlas_roi)
  rownames(cor_rs2_z[[i]]) <- as.vector(rois$atlas_roi)
  cor_rs2_z[[i]][is.infinite(cor_rs2_z[[i]])] <- NA
}

# mean within network corrs
mean_net_conn_t2 <- data.frame()

for (i in names(cor_rs2_z)) {
  mean_net_conn_t2[i,"Sub_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Subcortical","atlas_roi"]), colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Subcortical","atlas_roi"])],na.rm=T)
  mean_net_conn_t2[i,"SM_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Somatomotor","atlas_roi"]), colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Somatomotor","atlas_roi"])],na.rm=T)
  mean_net_conn_t2[i,"CiOp_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Cingulo-Opercular","atlas_roi"]), colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Cingulo-Opercular","atlas_roi"])],na.rm=T)
  mean_net_conn_t2[i,"FrPr_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Frontoparietal","atlas_roi"]), colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Frontoparietal","atlas_roi"])],na.rm=T)
  mean_net_conn_t2[i,"DMN_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Default","atlas_roi"]), colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Default","atlas_roi"])],na.rm=T)
  mean_net_conn_t2[i,"Vis1_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual1","atlas_roi"]), colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual1","atlas_roi"])],na.rm=T)
  mean_net_conn_t2[i,"Vis2_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual2","atlas_roi"]), colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual2","atlas_roi"])],na.rm=T)
  mean_net_conn_t2[i,"DAtt_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Dorsal-Attention","atlas_roi"]), colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Dorsal-Attention","atlas_roi"])],na.rm=T)
  mean_net_conn_t2[i,"Lang_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Language","atlas_roi"]), colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Language","atlas_roi"])],na.rm=T)
  mean_net_conn_t2[i,"Aud_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Auditory","atlas_roi"]), colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Auditory","atlas_roi"])],na.rm=T)
  mean_net_conn_t2[i,"Post_Mult_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Posterior-Multimodal","atlas_roi"]), colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Posterior-Multimodal","atlas_roi"])],na.rm=T)
  mean_net_conn_t2[i,"Vent_Mult_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Ventral-Multimodal","atlas_roi"]), colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Ventral-Multimodal","atlas_roi"])],na.rm=T)
  mean_net_conn_t2[i,"Orb_Aff_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Orbito-Affective","atlas_roi"]), colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Orbito-Affective","atlas_roi"])],na.rm=T)
  mean_net_conn_t2[i,"Bet_Sub_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Subcortical","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_SM_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Somatomotor","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Somatomotor","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_CiOp_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Cingulo-Opercular","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Cingulo-Opercular","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_FrPr_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Frontoparietal","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Frontoparietal","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_DMN_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Default","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Default","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_Vis1_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual1","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual1","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_Vis2_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual2","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual2","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_DAtt_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Dorsal-Attention","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Dorsal-Attention","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_Lang_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Language","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Language","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_Aud_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Auditory","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Auditory","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_Post_Mult_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Posterior-Multimodal","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Posterior-Multimodal","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_Vent_Mult_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Ventral-Multimodal","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Ventral-Multimodal","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_Orb_Aff_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Orbito-Affective","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Orbito-Affective","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_SM_Cort_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Somatomotor","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Somatomotor"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_CiOp_Cort_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Cingulo-Opercular","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Cingulo-Opercular"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_FrPr_Cort_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Frontoparietal","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Frontoparietal"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_DMN_Cort_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Default","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Default"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_Vis1_Cort_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual1","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual1"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_Vis2_Cort_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual2","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual2"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_DAtt_Cort_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Dorsal-Attention","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Dorsal-Attention"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_Lang_Cort_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Language","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Language"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_Aud_Cort_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Auditory","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Auditory"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_Post_Mult_Cort_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Posterior-Multimodal","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Posterior-Multimodal"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_Vent_Mult_Cort_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Ventral-Multimodal","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Ventral-Multimodal"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_Orb_Aff_Cort_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Orbito-Affective","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Orbito-Affective"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
} 

mean_net_conn_t2$STUDYID <- rownames(mean_net_conn_t2)
mean_net_conn_t2 <- mean_net_conn_t2[,c(39,1:38)]

```

```{r}
# merge clinical and t1 and t2 conn data
mean_bet_conn <- merge(mean_bet_conn_t1,mean_bet_conn_t2,by="STUDYID")
mean_net_conn <- merge(mean_net_conn_t1,mean_net_conn_t2,by="STUDYID")
clin_net_conn <- merge(stpd_clin,mean_net_conn,by="STUDYID")
clin_conn <- merge(clin_net_conn,mean_bet_conn,by="STUDYID")

# create difference score dfs
diff_bet_conn <- mean_bet_conn_t2[,2:79]-mean_bet_conn_t1[,2:79]
colnames(diff_bet_conn) <- sub("_t2", "", colnames(diff_bet_conn))
colnames(diff_bet_conn) <- sub("_t2", "_diff", colnames(diff_bet_conn))
diff_bet_conn$STUDYID <- rownames(diff_bet_conn)
diff_bet_conn <- diff_bet_conn[,c(79,1:78)]

diff_net_conn <- mean_net_conn_t2[,2:39]-mean_net_conn_t1[,2:39]
colnames(diff_net_conn) <- sub("_t2", "_diff", colnames(diff_net_conn))
diff_net_conn$STUDYID <- row.names(diff_net_conn)
diff_net_conn <- diff_net_conn[,c(39,1:38)]
clin_diff_net_conn <- merge(stpd_clin,diff_net_conn,by="STUDYID")
clin_diff_conn <- merge(clin_diff_net_conn,diff_bet_conn,by="STUDYID")

# write out csv with conn and clinical data 
#write.csv(clin_net_conn, '/projects/loliver/STOPPD_Long_FC/data/processed/behavioural/STOPPD_clinical_net_conn_11-15-2021.csv', row.names = FALSE)

```

```{r}
# analyses as per the JAMA psych paper (https://github.com/TIGRLab/STOPPD-MainPaper/)
# plot colours
RandomArmColors = c("#e6ab02", "#386cb0")

# table one with baseline values
CreateTableOne(data = clin_conn[,c(6,9:47,86:163)],strata = c("RandomArm"))

# also by site
#CreateTableOne(data = clin_conn[,c(2,6,9:24,40:117)],strata = c("RandomArm", "site"))

# table one with longitudinal values
# CreateTableOne(data = clin_conn[,c(6,9,48:85,164:241)],strata = c("RandomArm"))

```

```{r}
# reorganize data to run treatment x time models
clin_conn_long_t1 <- merge(mean_net_conn_t1,mean_bet_conn_t1,by="STUDYID")
clin_conn_long_t1$time <- rep("t1",58)
clin_conn_long_t1 <- merge(stpd_clin,clin_conn_long_t1,by="STUDYID")
colnames(clin_conn_long_t1)[10:47] <- sub("_t1", "", colnames(clin_conn_long_t1)[10:47])
colnames(clin_conn_long_t1)[48:125] <- sub("_t1", "", colnames(clin_conn_long_t1)[48:125])
colnames(clin_conn_long_t1)[48:125] <- sub("_t1", "", colnames(clin_conn_long_t1)[48:125])

clin_conn_long_t2 <- merge(mean_net_conn_t2,mean_bet_conn_t2,by="STUDYID")
clin_conn_long_t2$time <- rep("t2",58)
clin_conn_long_t2 <- merge(stpd_clin,clin_conn_long_t2,by="STUDYID")
colnames(clin_conn_long_t2)[10:47] <- sub("_t2", "", colnames(clin_conn_long_t2)[10:47])
colnames(clin_conn_long_t2)[48:125] <- sub("_t2", "", colnames(clin_conn_long_t2)[48:125])
colnames(clin_conn_long_t2)[48:125] <- sub("_t2", "", colnames(clin_conn_long_t2)[48:125])

clin_conn_long <- rbind(clin_conn_long_t1,clin_conn_long_t2)
clin_conn_long$model_days <- ifelse(clin_conn_long$time == "t1", 1, clin_conn_long$dateDiff)

```

```{r}
# primary analyses - mixed linear model - Vis2 network conn treatment x time in full group
for (i in colnames(clin_conn_long[,c(48,60:70)])) {
  print(i)
  assign(paste0("all_lmer_",i), lmer(get(i) ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), 
  data = clin_conn_long)) %>% summary() %>% print()
}

```

```{r}
# generate df with stats for treatment x time interaction 
trxti_df <- data.frame(matrix(NA, nrow = 5, ncol = 12))
colnames(trxti_df) <- colnames(clin_conn_long[,c(48,60:70)])
rownames(trxti_df) <- c("beta","SE","df","t","p")

for (i in colnames(clin_conn_long[,c(48,60:70)])) {
  trxti_df[[i]] <- as.vector(summary(lmer(get(i) ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), 
  data = clin_conn_long))[[10]][6,])
}

# transpose df, add fdr-corrected p values, and reorder columns 
trxti_df <- data.frame(t(trxti_df))
trxti_df$p_fdr <- p.adjust(trxti_df$p, method = "fdr")
trxti_df <- trxti_df[,c(1,2,4,3,5,6)]

print(trxti_df)

#write.csv(trxti_df,file="/projects/loliver/STOPPD_Long_FC/results/treatxtime_fullbetconn.csv")

```

```{r}
# plot treatment arm x time 
ggplot(clin_conn_long, aes(x=model_days, y=Bet_Vis2, fill = RandomArm)) + 
  geom_point(aes(shape = PlotLabel)) + 
  geom_line(aes(group=STUDYID, color = RandomArm), alpha = 0.5) + 
  geom_smooth(aes(color = RandomArm), method="lm", fill = "grey40") +
  labs(x ="Days between MRIs", 
       y = "Secondary Visual Between-Network Connectivity",
       shape = "Status at scan 2",
       color = "Group") +
  scale_colour_manual(values = RandomArmColors) +
  scale_fill_manual(values = RandomArmColors) +
  scale_shape_manual(values = c(21:23)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank())

ggplot(clin_conn_long, aes(x=model_days, y=Vis2.Orb_Aff, fill = RandomArm)) + 
  geom_point(aes(shape = PlotLabel)) + 
  geom_line(aes(group=STUDYID, color = RandomArm), alpha = 0.5) + 
  geom_smooth(aes(color = RandomArm), method="lm", fill = "grey40") +
  labs(x ="Days between MRIs", 
       y = "Secondary Visual - Orbito-Affective Connectivity",
       shape = "Status at scan 2",
       color = "Group") +
  guides(fill=FALSE) +
  scale_colour_manual(values = RandomArmColors) +
  scale_fill_manual(values = RandomArmColors) +
  scale_shape_manual(values = c(21:23)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank())

ggplot(clin_conn_long, aes(x=model_days, y=Vis2.CiOp, fill = RandomArm)) + 
  geom_point(aes(shape = PlotLabel)) + 
  geom_line(aes(group=STUDYID, color = RandomArm), alpha = 0.5) + 
  geom_smooth(aes(color = RandomArm), method="lm", fill = "grey40") +
  labs(x ="Days between MRIs", 
       y = "Secondary Visual - Cingulo-Opercular Connectivity",
       shape = "Status at scan 2",
       color = "Group") +
  guides(fill=FALSE) +
  scale_colour_manual(values = RandomArmColors) +
  scale_fill_manual(values = RandomArmColors) +
  scale_shape_manual(values = c(21:23)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank())

ggplot(clin_conn_long, aes(x=model_days, y=Vis2.Aud, fill = RandomArm)) + 
  geom_point(aes(shape = PlotLabel)) + 
  geom_line(aes(group=STUDYID, color = RandomArm), alpha = 0.5) + 
  geom_smooth(aes(color = RandomArm), method="lm", fill = "grey40") +
  labs(x ="Days between MRIs", 
       y = "Secondary Visual - Auditory Connectivity",
       shape = "Status at scan 2",
       color = "Group") +
  guides(fill=FALSE) +
  scale_colour_manual(values = RandomArmColors) +
  scale_fill_manual(values = RandomArmColors) +
  scale_shape_manual(values = c(21:23)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank())

ggplot(clin_conn_long, aes(x=model_days, y=Vis2.Sub, fill = RandomArm)) + 
  geom_point(aes(shape = PlotLabel)) + 
  geom_line(aes(group=STUDYID, color = RandomArm), alpha = 0.5) + 
  geom_smooth(aes(color = RandomArm), method="lm", fill = "grey40") +
  labs(x ="Days between MRIs", 
       y = "Secondary Visual - Subcortical Connectivity",
       shape = "Status at scan 2",
       color = "Group") +
  guides(fill=FALSE) +
  scale_colour_manual(values = RandomArmColors) +
  scale_fill_manual(values = RandomArmColors) +
  scale_shape_manual(values = c(21:23)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank())

```

```{r}
# post hoc analyses - time in olanzapine only
# mixed linear model - Vis2.Orb_Aff 
summary(lmer(Vis2.Orb_Aff ~ model_days + sex + age + (1|site) + (1|STUDYID), 
  data = clin_conn_long[clin_conn_long$RandomArm=="Olanzapine",]))

# t-test for t2 vs t1 diff - Vis2.Orb_Aff 
t.test(Vis2.Orb_Aff ~ time,data=clin_conn_long[clin_conn_long$RandomArm=="Olanzapine",],paired=T)

# Vis2.CiOp 
t.test(Vis2.CiOp ~ time,data=clin_conn_long[clin_conn_long$RandomArm=="Olanzapine",],paired=T)

```

```{r}
# post hoc analyses - time in placebo only
# mixed linear model - Vis2.Orb_Aff  
summary(lmer(Vis2.Orb_Aff ~ model_days + sex + age + (1|site) + (1|STUDYID), 
  data = clin_conn_long[clin_conn_long$RandomArm=="Placebo",]))

# t-test for t2 vs t1 diff - Vis2.Orb_Aff 
t.test(Vis2.Orb_Aff ~ time,data=clin_conn_long[clin_conn_long$RandomArm=="Placebo",],paired=T)

# Vis2.CiOp
t.test(Vis2.CiOp ~ time,data=clin_conn_long[clin_conn_long$RandomArm=="Placebo",],paired=T)

```

```{r}
# exploratory analysis - mixed linear model - Vis2 network conn clinical outcome x time (excluding off protocol N=53; not a meaningful clinical outcome)
for (i in colnames(clin_conn_long[,c(48,60:70)])) {
  print(i)
  assign(paste0("exp_lmer_",i), lmer(get(i) ~ ClinicalOutcome*model_days + sex + age + (1|site) + (1|STUDYID), 
  data = clin_conn_long[clin_conn_long$ClinicalOutcome != "Off protocol",])) %>% summary() %>% print()
}

```

```{r}
# generate df with stats for clinical outcome x time interaction 
clinxti_df <- data.frame(matrix(NA, nrow = 5, ncol = 12))
colnames(clinxti_df) <- colnames(clin_conn_long[,c(48,60:70)])
rownames(clinxti_df) <- c("beta","SE","df","t","p")

for (i in colnames(clin_conn_long[,c(48,60:70)])) {
  clinxti_df[[i]] <- as.vector(summary(lmer(get(i) ~ ClinicalOutcome*model_days + sex + age + (1|site) + (1|STUDYID), 
  data = clin_conn_long[clin_conn_long$ClinicalOutcome != "Off protocol",]))[[10]][6,])
}

# transpose df, add fdr-corrected p values, and reorder columns 
clinxti_df <- data.frame(t(clinxti_df))
clinxti_df$p_fdr <- p.adjust(clinxti_df$p, method = "fdr")
clinxti_df <- clinxti_df[,c(1,2,4,3,5,6)]

print(clinxti_df)

#write.csv(clinxti_df,file="/projects/loliver/STOPPD_Long_FC/results/clinxtime_fullbetconn.csv")

```

```{r}
# plot clinical outcome x time 
ggplot(clin_conn_long[clin_conn_long$ClinicalOutcome != "Off protocol",], aes(x=model_days, y=Vis1.Vis2, fill = ClinicalOutcome)) + 
  geom_point(aes(shape = RandomArm)) + 
  geom_line(aes(group=STUDYID, color = ClinicalOutcome), alpha = 0.5) + 
  geom_smooth(aes(color = ClinicalOutcome), method="lm", fill = "grey40") +
  labs(x ="Days between MRIs", 
       y = "Vis1 Vis2 Connectivity",
       shape = "Group",
       color = "Clinical Outcome") +
  guides(fill=FALSE) +
  scale_colour_manual(values = c("springgreen1","mediumpurple1","lightpink")) +
  scale_fill_manual(values = c("springgreen1","mediumpurple1","lightpink")) +
  scale_shape_manual(values = c(21:23)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank())

```



When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.