---
title: "02_STOPPD_GraphMetrics_pos_thresholds"
output: html_notebook
---

# STOP-PD functional analyses with BCT graph metrics using proportional thresholding (negative values eliminated) from 15-35%

```{r}
library(tidyr)
library(dplyr)
library(tableone)
library(ggplot2)
library(lme4)
library(lmerTest)
library(broom)

```

```{r}
# read in clinical data for those who passed imaging QC (as per /projects/loliver/STOPPD_Long_FC/data/raw/stoppd_usable_rsFC_sublist_Nick.csv)
# original csv generated by Erin for the JAMA Psych paper
stpd_clin <- read.csv(file = "/projects/loliver/STOPPD_Long_FC/data/raw/STOPPD_clinical_fc.csv", header=T) %>%
  mutate(STUDYID = as.character(STUDYID),
         dateDiff = as.numeric(dateDiff),
         site = as.factor(site),
         RandomArm = factor(randomization, 
                           levels = c("O", "P"), labels = c("Olanzapine", "Placebo")),
         sex = factor(sex, levels = c("M", "F"), labels = c("Male", "Female")),
         ClinicalOutcome = factor(ClinicalOutcome, 
                             levels = c("Remission","Relapse", "Off protocol")),
         PlotLabel = factor(PlotLabel, 
                       levels = c("Sustained Remisson","Relapse", "Discontinued_Remission"),
                       labels = c("Sustained Remisson","Relapse", "Discontinued"))) 

# exclude 210012 (116 TRs vs 206), 210013 (116 TRs), 220002 (116 TRs), and 320006 (146 TRs) due to incomplete RS ses-01 data
# 220002 also has incomplete RS ses-02 data (116 TRs)  
stpd_clin <- stpd_clin[stpd_clin$STUDYID!="210012" & stpd_clin$STUDYID!="210013" & stpd_clin$STUDYID!="220002" & stpd_clin$STUDYID!="320006",]

# exclude 410012 and 320032 due to intracranial findings
stpd_clin <- stpd_clin[stpd_clin$STUDYID!="410012" & stpd_clin$STUDYID!="320032",]

# reorder data by ascending ID to align with matlab outputs
stpd_clin <- stpd_clin[order(stpd_clin$STUDYID),]

```

```{r}
# read in BCT metrics at 5-35% density (5% increments) using proportional thresholding across values (neg eliminated)
# cortical and subcortical ROIs
# clustering coefficient, global efficiency, transitivity, characteristic path length, modularity

# ses-01
conn_gt_5_t1 <- read.csv(file = "/projects/loliver/STOPPD_Long_FC/data/processed/graph_metrics/ses-01/pos_whole_5.csv", header=F)
conn_gt_10_t1 <- read.csv(file = "/projects/loliver/STOPPD_Long_FC/data/processed/graph_metrics/ses-01/pos_whole_10.csv", header=F)
conn_gt_15_t1 <- read.csv(file = "/projects/loliver/STOPPD_Long_FC/data/processed/graph_metrics/ses-01/pos_whole_15.csv", header=F)
conn_gt_20_t1 <- read.csv(file = "/projects/loliver/STOPPD_Long_FC/data/processed/graph_metrics/ses-01/pos_whole_20.csv", header=F)
conn_gt_25_t1 <- read.csv(file = "/projects/loliver/STOPPD_Long_FC/data/processed/graph_metrics/ses-01/pos_whole_25.csv", header=F)
conn_gt_30_t1 <- read.csv(file = "/projects/loliver/STOPPD_Long_FC/data/processed/graph_metrics/ses-01/pos_whole_30.csv", header=F)
conn_gt_35_t1 <- read.csv(file = "/projects/loliver/STOPPD_Long_FC/data/processed/graph_metrics/ses-01/pos_whole_35.csv", header=F)

# ses-02
conn_gt_5_t2 <- read.csv(file = "/projects/loliver/STOPPD_Long_FC/data/processed/graph_metrics/ses-02/pos_whole_5.csv", header=F)
conn_gt_10_t2 <- read.csv(file = "/projects/loliver/STOPPD_Long_FC/data/processed/graph_metrics/ses-02/pos_whole_10.csv", header=F)
conn_gt_15_t2 <- read.csv(file = "/projects/loliver/STOPPD_Long_FC/data/processed/graph_metrics/ses-02/pos_whole_15.csv", header=F)
conn_gt_20_t2 <- read.csv(file = "/projects/loliver/STOPPD_Long_FC/data/processed/graph_metrics/ses-02/pos_whole_20.csv", header=F)
conn_gt_25_t2 <- read.csv(file = "/projects/loliver/STOPPD_Long_FC/data/processed/graph_metrics/ses-02/pos_whole_25.csv", header=F)
conn_gt_30_t2 <- read.csv(file = "/projects/loliver/STOPPD_Long_FC/data/processed/graph_metrics/ses-02/pos_whole_30.csv", header=F)
conn_gt_35_t2 <- read.csv(file = "/projects/loliver/STOPPD_Long_FC/data/processed/graph_metrics/ses-02/pos_whole_35.csv", header=F)

# merge t1 and t2 conn data
conn_gt_5 <- data.frame(cbind(conn_gt_5_t1,conn_gt_5_t2[,2:6]))
conn_gt_10 <- data.frame(cbind(conn_gt_10_t1,conn_gt_10_t2[,2:6]))
conn_gt_15 <- data.frame(cbind(conn_gt_15_t1,conn_gt_15_t2[,2:6]))
conn_gt_20 <- data.frame(cbind(conn_gt_20_t1,conn_gt_20_t2[,2:6]))
conn_gt_25 <- data.frame(cbind(conn_gt_25_t1,conn_gt_25_t2[,2:6]))
conn_gt_30 <- data.frame(cbind(conn_gt_30_t1,conn_gt_30_t2[,2:6]))
conn_gt_35 <- data.frame(cbind(conn_gt_35_t1,conn_gt_35_t2[,2:6]))

# make list
conn_gt <- list(conn_gt_5,conn_gt_10,conn_gt_15,conn_gt_20,conn_gt_25,conn_gt_30,conn_gt_35)
names(conn_gt) <- c("thr5","thr10","thr15","thr20","thr25","thr30","thr35")

# change subid var (matlab csvwrite rounds after 5 digits - confirmed this is correct), add colnames, reorder columns, and merge with clinical data
clin_gt <- list()

for (i in names(conn_gt)) {
  conn_gt[[i]]$V1 <- as.character(stpd_clin$STUDYID)
  colnames(conn_gt[[i]]) <- c("STUDYID","cc_t1","ge_t1","trans_t1","cpl_t1","q_t1","cc_t2","ge_t2","trans_t2","cpl_t2","q_t2")
  conn_gt[[i]] <- conn_gt[[i]][,c(1,3,2,4,6,5,8,7,9,11,10)]
  clin_gt[[i]] <- merge(stpd_clin,conn_gt[[i]],by="STUDYID")
}

```

```{r}
# analyses as per the JAMA psych paper (following Erin's github) 

# Erin's plot colours
RandomArmColors = c("#e6ab02", "#386cb0")

# make difference scores
for (i in names(clin_gt)) {
clin_gt[[i]]$ge_diff <- clin_gt[[i]]$ge_t2 - clin_gt[[i]]$ge_t1
clin_gt[[i]]$cc_diff <- clin_gt[[i]]$cc_t2 - clin_gt[[i]]$cc_t1
clin_gt[[i]]$trans_diff <- clin_gt[[i]]$trans_t2 - clin_gt[[i]]$trans_t1
clin_gt[[i]]$q_diff <- clin_gt[[i]]$q_t2 - clin_gt[[i]]$q_t1
clin_gt[[i]]$cpl_diff <- clin_gt[[i]]$cpl_t2 - clin_gt[[i]]$cpl_t1
}

# baseline t tests
for (i in names(clin_gt)) {
print(i)
print(t.test(cc_t1 ~ RandomArm, data = clin_gt[[i]]))
print(t.test(ge_t1 ~ RandomArm, data = clin_gt[[i]]))
print(t.test(trans_t1 ~ RandomArm, data = clin_gt[[i]]))
print(t.test(cpl_t1 ~ RandomArm, data = clin_gt[[i]]))
print(t.test(q_t1 ~ RandomArm, data = clin_gt[[i]]))
}

```

```{r}
# primary analyses - mixed linear model - graph metrics treatment x time in full group

# GE treatment x time in full group
for (i in names(clin_gt)) {
  print(i)
  assign(paste0("all_ge_lmer_",i), lmer(ge ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), 
  data = (clin_gt[[i]] %>% gather(oldcolname, ge, ge_t1, ge_t2) %>% mutate(model_days = if_else(oldcolname == "ge_t1", 1, dateDiff))))) %>%
  summary() %>% print()
  }

# CC treatment x time in full group
for (i in names(clin_gt)) {
  print(i)
  assign(paste0("all_cc_lmer_",i), lmer(cc ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), 
  data = (clin_gt[[i]] %>% gather(oldcolname, cc, cc_t1, cc_t2) %>% mutate(model_days = if_else(oldcolname == "cc_t1", 1, dateDiff))))) %>%
  summary() %>% print()
  }

# transitivity treatment x time in full group
for (i in names(clin_gt)) {
  print(i)
  assign(paste0("all_trans_lmer_",i), lmer(trans ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), 
  data = (clin_gt[[i]] %>% gather(oldcolname, trans, trans_t1, trans_t2) %>% mutate(model_days = if_else(oldcolname == "trans_t1", 1, dateDiff))))) %>%
  summary() %>% print()
  }

# modularity treatment x time in full group
for (i in names(clin_gt)) {
  print(i)
  assign(paste0("all_q_lmer_",i), lmer(q ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), 
  data = (clin_gt[[i]] %>% gather(oldcolname, q, q_t1, q_t2) %>% mutate(model_days = if_else(oldcolname == "q_t1", 1, dateDiff))))) %>%
  summary() %>% print()
  }

# characteristic path length treatment x time in full group
for (i in names(clin_gt)) {
  print(i)
  assign(paste0("all_cpl_lmer_",i), lmer(cpl ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), 
  data = (clin_gt[[i]] %>% gather(oldcolname, cpl, cpl_t1, cpl_t2) %>% mutate(model_days = if_else(oldcolname == "cpl_t1", 1, dateDiff))))) %>%
  summary() %>% print()
  }

```

```{r}
# generate df with stats for treatment x time interaction 
# GE
trxti_ge <- data.frame(matrix(NA, nrow = 5, ncol = 7))
colnames(trxti_ge) <- names(clin_gt)
rownames(trxti_ge) <- c("beta","SE","df","t","p")

for (i in names(clin_gt)) {
  trxti_ge[[i]] <- as.vector(summary(lmer(ge ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), 
  data = (clin_gt[[i]] %>% gather(oldcolname, ge, ge_t1, ge_t2) %>% mutate(model_days = if_else(oldcolname == "ge_t1", 1, dateDiff)))))[[10]][6,])
}

# transpose df, keep only densities 5-25%, and reorder columns 
trxti_ge <- data.frame(t(trxti_ge))
#trxti_ge$p_fdr <- p.adjust(trxti_ge$p, method = "fdr")
trxti_ge <- trxti_ge[1:5,c(1,2,4,3,5)]

print(trxti_ge)

#write.csv(trxti_ge,file="/projects/loliver/STOPPD_Long_FC/results/supp_treatxtime_thresh_ge.csv")


# CC
trxti_cc <- data.frame(matrix(NA, nrow = 5, ncol = 7))
colnames(trxti_cc) <- names(clin_gt)
rownames(trxti_cc) <- c("beta","SE","df","t","p")

for (i in names(clin_gt)) {
  trxti_cc[[i]] <- as.vector(summary(lmer(cc ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), 
  data = (clin_gt[[i]] %>% gather(oldcolname, cc, cc_t1, cc_t2) %>% mutate(model_days = if_else(oldcolname == "cc_t1", 1, dateDiff)))))[[10]][6,])
}

# transpose df, keep only densities 5-25%, and reorder columns 
trxti_cc <- data.frame(t(trxti_cc))
#trxti_cc$p_fdr <- p.adjust(trxti_cc$p, method = "fdr")
trxti_cc <- trxti_cc[1:5,c(1,2,4,3,5)]

print(trxti_cc)

#write.csv(trxti_cc,file="/projects/loliver/STOPPD_Long_FC/results/supp_treatxtime_thresh_cc.csv")


# transitivity
trxti_trans <- data.frame(matrix(NA, nrow = 5, ncol = 7))
colnames(trxti_trans) <- names(clin_gt)
rownames(trxti_trans) <- c("beta","SE","df","t","p")

for (i in names(clin_gt)) {
  trxti_trans[[i]] <- as.vector(summary(lmer(trans ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), 
  data = (clin_gt[[i]] %>% gather(oldcolname, trans, trans_t1, trans_t2) %>% mutate(model_days = if_else(oldcolname == "trans_t1", 1, dateDiff)))))[[10]][6,])
}

# transpose df, keep only densities 5-25%, and reorder columns 
trxti_trans <- data.frame(t(trxti_trans))
#trxti_trans$p_fdr <- p.adjust(trxti_trans$p, method = "fdr")
trxti_trans <- trxti_trans[1:5,c(1,2,4,3,5)]

print(trxti_trans)

#write.csv(trxti_trans,file="/projects/loliver/STOPPD_Long_FC/results/supp_treatxtime_thresh_trans.csv")


# modularity
trxti_q <- data.frame(matrix(NA, nrow = 5, ncol = 7))
colnames(trxti_q) <- names(clin_gt)
rownames(trxti_q) <- c("beta","SE","df","t","p")

for (i in names(clin_gt)) {
  trxti_q[[i]] <- as.vector(summary(lmer(q ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), 
  data = (clin_gt[[i]] %>% gather(oldcolname, q, q_t1, q_t2) %>% mutate(model_days = if_else(oldcolname == "q_t1", 1, dateDiff)))))[[10]][6,])
}

# transpose df, keep only densities 5-25%, and reorder columns 
trxti_q <- data.frame(t(trxti_q))
#trxti_q$p_fdr <- p.adjust(trxti_q$p, method = "fdr")
trxti_q <- trxti_q[1:5,c(1,2,4,3,5)]

print(trxti_q)

#write.csv(trxti_q,file="/projects/loliver/STOPPD_Long_FC/results/supp_treatxtime_thresh_q.csv")

```


```{r eval=F}
# plot of change in GE treatment arm x time - skipped for now 
ggplot(all_ge, aes(x=model_days, y=ge, fill = RandomArm)) + 
  geom_point(aes(shape = PlotLabel)) + 
  geom_line(aes(group=STUDYID, color = RandomArm), alpha = 0.5) + 
  geom_smooth(aes(color = RandomArm), method="lm", fill = "grey40") +
  labs(x ="Days between MRIs", 
       y = "Global Efficiency",
       shape = "Status at scan 2",
       color = "Group") +
  scale_colour_manual(values = RandomArmColors) +
  scale_fill_manual(values = RandomArmColors) +
  scale_shape_manual(values = c(21:23)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank())

```


```{r}
# secondary analyses - graph metrics treatment in remitters only (sustained remission, discontinuers removed) # N=30

# global efficiency change with covariates of sex, age, and site intercept
for (i in names(clin_gt)) {
  print(i)
  assign(paste0("rem_ge_lmer_",i), lmer(ge_diff ~ RandomArm + sex + age + (1|site), 
  data = (clin_gt[[i]] %>% filter(ClinicalOutcome == "Remission" & PlotLabel != "Discontinued")))) %>%
  summary() %>% print()
  }

# clustering coefficient
for (i in names(clin_gt)) {
  print(i)
  assign(paste0("rem_cc_lmer_",i), lmer(cc_diff ~ RandomArm + sex + age + (1|site), 
  data = (clin_gt[[i]] %>% filter(ClinicalOutcome == "Remission" & PlotLabel != "Discontinued")))) %>%
  summary() %>% print()
  }

# trans
for (i in names(clin_gt)) {
  print(i)
  assign(paste0("rem_trans_lmer_",i), lmer(trans_diff ~ RandomArm + sex + age + (1|site), 
  data = (clin_gt[[i]] %>% filter(ClinicalOutcome == "Remission" & PlotLabel != "Discontinued")))) %>%
  summary() %>% print()
  }

# Modularity (Q)
for (i in names(clin_gt)) {
  print(i)
  assign(paste0("rem_q_lmer_",i), lmer(q_diff ~ RandomArm + sex + age + (1|site), 
  data = (clin_gt[[i]] %>% filter(ClinicalOutcome == "Remission" & PlotLabel != "Discontinued")))) %>%
  summary() %>% print()
  }

# CPL
for (i in names(clin_gt)) {
  print(i)
  assign(paste0("rem_cpl_lmer_",i), lmer(cpl_diff ~ RandomArm + sex + age + (1|site), 
  data = (clin_gt[[i]] %>% filter(ClinicalOutcome == "Remission" & PlotLabel != "Discontinued")))) %>%
  summary() %>% print()
  }

```

```{r}
# generate df with stats for treatment
# GE
rem_tr_ge <- data.frame(matrix(NA, nrow = 5, ncol = 7))
colnames(rem_tr_ge) <- names(clin_gt)
rownames(rem_tr_ge) <- c("beta","SE","df","t","p")

for (i in names(clin_gt)) {
  rem_tr_ge[[i]] <- as.vector(summary(lmer(ge_diff ~ RandomArm + sex + age + (1|site), 
  data = (clin_gt[[i]] %>% filter(ClinicalOutcome == "Remission" & PlotLabel != "Discontinued"))))[[10]][2,])
}

# transpose df, keep only densities 5-25%, and reorder columns 
rem_tr_ge <- data.frame(t(rem_tr_ge))
#rem_tr_ge$p_fdr <- p.adjust(rem_tr_ge$p, method = "fdr")
rem_tr_ge <- rem_tr_ge[1:5,c(1,2,4,3,5)]

print(rem_tr_ge)

#write.csv(rem_tr_ge,file="/projects/loliver/STOPPD_Long_FC/results/supp_rem_tr_thresh_ge.csv")


# CC
rem_tr_cc <- data.frame(matrix(NA, nrow = 5, ncol = 7))
colnames(rem_tr_cc) <- names(clin_gt)
rownames(rem_tr_cc) <- c("beta","SE","df","t","p")

for (i in names(clin_gt)) {
  rem_tr_cc[[i]] <- as.vector(summary(lmer(cc_diff ~ RandomArm + sex + age + (1|site), 
  data = (clin_gt[[i]] %>% filter(ClinicalOutcome == "Remission" & PlotLabel != "Discontinued"))))[[10]][2,])
}

# transpose df, keep only densities 5-25%, and reorder columns 
rem_tr_cc <- data.frame(t(rem_tr_cc))
#rem_tr_cc$p_fdr <- p.adjust(rem_tr_cc$p, method = "fdr")
rem_tr_cc <- rem_tr_cc[1:5,c(1,2,4,3,5)]

print(rem_tr_cc)

#write.csv(rem_tr_cc,file="/projects/loliver/STOPPD_Long_FC/results/supp_rem_tr_thresh_cc.csv")


# trans
rem_tr_trans <- data.frame(matrix(NA, nrow = 5, ncol = 7))
colnames(rem_tr_trans) <- names(clin_gt)
rownames(rem_tr_trans) <- c("beta","SE","df","t","p")

for (i in names(clin_gt)) {
  rem_tr_trans[[i]] <- as.vector(summary(lmer(trans_diff ~ RandomArm + sex + age + (1|site), 
  data = (clin_gt[[i]] %>% filter(ClinicalOutcome == "Remission" & PlotLabel != "Discontinued"))))[[10]][2,])
}

# transpose df, keep only densities 5-25%, and reorder columns 
rem_tr_trans <- data.frame(t(rem_tr_trans))
#rem_tr_trans$p_fdr <- p.adjust(rem_tr_trans$p, method = "fdr")
rem_tr_trans <- rem_tr_trans[1:5,c(1,2,4,3,5)]

print(rem_tr_trans)

#write.csv(rem_tr_trans,file="/projects/loliver/STOPPD_Long_FC/results/supp_rem_tr_thresh_trans.csv")


# modularity
rem_tr_q <- data.frame(matrix(NA, nrow = 5, ncol = 7))
colnames(rem_tr_q) <- names(clin_gt)
rownames(rem_tr_q) <- c("beta","SE","df","t","p")

for (i in names(clin_gt)) {
  rem_tr_q[[i]] <- as.vector(summary(lmer(q_diff ~ RandomArm + sex + age + (1|site), 
  data = (clin_gt[[i]] %>% filter(ClinicalOutcome == "Remission" & PlotLabel != "Discontinued"))))[[10]][2,])
}

# transpose df, keep only densities 5-25%, and reorder columns 
rem_tr_q <- data.frame(t(rem_tr_q))
#rem_tr_q$p_fdr <- p.adjust(rem_tr_q$p, method = "fdr")
rem_tr_q <- rem_tr_q[1:5,c(1,2,4,3,5)]

print(rem_tr_q)

#write.csv(rem_tr_q,file="/projects/loliver/STOPPD_Long_FC/results/supp_rem_tr_thresh_q.csv")

```


```{r fig.height=4, fig.width=7, eval=F}
# boxplot of difference in graph metrics (y axis) by RandomArm group (x axis) in remitters only - skipped for now - could update to show across densities

rem_conn_15 %>% 
  gather(gt_metric, change, ge_diff, cc_diff, trans_diff, q_diff) %>%
ggplot(aes(x= RandomArm, y = change, fill = RandomArm)) + 
     geom_boxplot(outlier.shape = NA, alpha = 0.0001) + 
     geom_dotplot(binaxis = 'y', stackdir = 'center') +
     geom_hline(yintercept = 0) +
     labs( x=NULL,      
           y = bquote('Change in Graph Metric'),
           fill = "Group") +
     scale_fill_manual(values = RandomArmColors) +
     scale_shape_manual(values = c(21)) +
     facet_wrap(~gt_metric) +
     theme_bw() +
     theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank())


# global efficiency only
ggplot(rem_conn_15, aes(x= RandomArm, y = ge_diff, fill = RandomArm)) + 
     geom_boxplot(outlier.shape = NA, alpha = 0.0001) + 
     geom_dotplot(binaxis = 'y', stackdir = 'center') +
     geom_hline(yintercept = 0) +
     labs( x=NULL,      
           y = bquote('Change in Global Efficiency'),
           fill = "Group") +
     scale_fill_manual(values = RandomArmColors) +
     scale_shape_manual(values = c(21)) +
 #    facet_wrap(~Region) + could use for densities
     theme_bw() +
     theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank())

```



Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
