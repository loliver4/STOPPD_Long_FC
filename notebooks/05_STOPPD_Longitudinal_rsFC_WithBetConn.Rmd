---
title: "STOPPD_Longitudinal_rsFC_WithBetConn"
output: html_notebook
---

# STOP-PD functional analyses with within- and between-network connectivity

```{r, message=FALSE, warning=FALSE, results=FALSE}
library(splitstackshape)
library(tidyr)
library(dplyr)
library(corrr)
library(psych)
library(tableone)
library(corrplot)
library(ggplot2)
library(effsize)
library(lme4)
library(lmerTest)
library(broom)

```

```{r, warning=FALSE, results=FALSE}
# set working dir
setwd("/projects/loliver/STOPPD_Long_FC/data/processed")

# find baseline RS time series files  # pattern glob2rx("sub-?????????_ses-01_run-*_RS_2mm_glasser_tian_meants.csv")
# subject IDs with 10 characters are for control repeat/longitudinal scans (extra R in the ID)
files_RS_ts1 <- list.files(path= ".", recursive=T, full.names=F, pattern="^sub-........._ses-01_run-.*_RS_2mm_glasser_tian_meants\\.csv$")

# confirm csvs aren't empty
files_RS_ts1[file.size(files_RS_ts1) == 0]

# create list of IDs
ptlist1 <- substring(files_RS_ts1,8,13)

# read in time series files
RS_ts1 <- lapply(files_RS_ts1, read.csv, header=F)

# transpose dfs
RS_ts1 <- lapply(RS_ts1, t)

# Name dfs with participant IDs
names(RS_ts1) <- ptlist1

```
```{r, warning=FALSE, results=FALSE}
# set working dir
setwd("/projects/loliver/STOPPD_Long_FC/data/processed")

# find patient longitudinal RS time series files  # pattern glob2rx("sub-?????????_ses-02_run-*_RS_2mm_glasser_tian_meants.csv")
# subject IDs with 10 characters are for control repeat/longitudinal scans (extra R in the ID)
files_RS_ts2 <- list.files(path= ".", recursive=T, full.names=F, pattern="^sub-........._ses-02_run-.*_RS_2mm_glasser_tian_meants\\.csv$")

# confirm csvs aren't empty
files_RS_ts2[file.size(files_RS_ts2) == 0]

# create list of IDs
ptlist2 <- substring(files_RS_ts2,8,13)

# read in time series files
RS_ts2 <- lapply(files_RS_ts2, read.csv, header=F)

# transpose dfs
RS_ts2 <- lapply(RS_ts2, t)

# Name dfs with participant IDs
names(RS_ts2) <- ptlist2


# keep only those with both baseline and longitudinal data - not actually necessary atm
#RS_ts1 <- RS_ts1[names(RS_ts1) %in% names(RS_ts2)]

```

```{r}
# read in clinical data for those who passed imaging QC (as per /projects/loliver/STOPPD_Long_FC/data/raw/stoppd_usable_rsFC_sublist_Nick.csv)
# original csv generated by Erin for the JAMA Psych paper
stpd_clin <- read.csv(file = "/projects/loliver/STOPPD_Long_FC/data/raw/STOPPD_clinical_fc.csv", header=T) %>%
  mutate(STUDYID = as.character(STUDYID),
         dateDiff = as.numeric(dateDiff),
         site = as.factor(site),
         RandomArm = factor(randomization, 
                           levels = c("O", "P"), labels = c("Olanzapine", "Placebo")),
         sex = factor(sex, levels = c("M", "F"), labels = c("Male", "Female")),
         ClinicalOutcome = factor(ClinicalOutcome, 
                             levels = c("Remission","Relapse", "Off protocol")),
         PlotLabel = factor(PlotLabel, 
                       levels = c("Sustained Remisson","Relapse", "Discontinued_Remission"),
                       labels = c("Sustained Remisson","Relapse", "Discontinued"))) 

# drop added hamd scores so as not to interfere with for loops below
stpd_clin <- stpd_clin[,c(1:8,12)]

# exclude 210012 (116 TRs vs 206), 210013 (116 TRs), 220002 (116 TRs), and 320006 (146 TRs) due to incomplete RS ses-01 data
# 220002 also has incomplete RS ses-02 data (116 TRs)  
stpd_clin <- stpd_clin[stpd_clin$STUDYID!="210012" & stpd_clin$STUDYID!="210013" & stpd_clin$STUDYID!="220002" & stpd_clin$STUDYID!="320006",]

# exclude 410012 and 320032 due to intracranial findings
stpd_clin <- stpd_clin[stpd_clin$STUDYID!="410012" & stpd_clin$STUDYID!="320032",]

# keep conn data for eligible participants who passed QC
RS_ts1 <- RS_ts1[names(RS_ts1) %in% stpd_clin$STUDYID]
RS_ts2 <- RS_ts2[names(RS_ts2) %in% stpd_clin$STUDYID]

# identify participant with missing conn data - sub-CMH420018 was missing fmriprep func data for ses-01 in the archive, but this exists now
stpd_clin[!(stpd_clin$STUDYID %in% names(RS_ts1)),]

# write out csv for current sample
#write.csv(stpd_clin,file="/projects/loliver/STOPPD_Long_FC/data/processed/behavioural/STOPPD_clinical_fc.csv", row.names=F)

```

```{r}
# read in Tian and Glasser ROI labels (392)
rois <- read.csv(file = "/projects/loliver/STOPPD_Long_FC/data/raw/Glasser_Tian_roi_info.csv", header=T)

# add ROIs as colnames 
for (i in names(RS_ts1)) {
  colnames(RS_ts1[[i]]) <- as.vector(rois$atlas_roi)
}

```

```{r}
# generate baseline correlation matrices for each participant for within- and between-network conn
cor_rs1  <- lapply(RS_ts1, cor)

# fisher z transform corrs to normalize dist
cor_rs1_z  <- lapply(cor_rs1, fisherz)

# add ROI names and replace inf values with NA for mean calculations 
for (i in names(cor_rs1_z)) {
  colnames(cor_rs1_z[[i]]) <- as.vector(rois$atlas_roi)
  rownames(cor_rs1_z[[i]]) <- as.vector(rois$atlas_roi)
  cor_rs1_z[[i]][is.infinite(cor_rs1_z[[i]])] <- NA
}

# mean within and between network corrs
mean_net_conn_t1 <- data.frame()

for (i in names(cor_rs1_z)) {
  mean_net_conn_t1[i,"Sub_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Subcortical","atlas_roi"]), colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Subcortical","atlas_roi"])],na.rm=T)
  mean_net_conn_t1[i,"SM_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Somatomotor","atlas_roi"]), colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Somatomotor","atlas_roi"])],na.rm=T)
  mean_net_conn_t1[i,"CiOp_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Cingulo-Opercular","atlas_roi"]), colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Cingulo-Opercular","atlas_roi"])],na.rm=T)
  mean_net_conn_t1[i,"FrPr_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Frontoparietal","atlas_roi"]), colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Frontoparietal","atlas_roi"])],na.rm=T)
  mean_net_conn_t1[i,"DMN_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Default","atlas_roi"]), colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Default","atlas_roi"])],na.rm=T)
  mean_net_conn_t1[i,"Vis1_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual1","atlas_roi"]), colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual1","atlas_roi"])],na.rm=T)
  mean_net_conn_t1[i,"Vis2_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual2","atlas_roi"]), colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual2","atlas_roi"])],na.rm=T)
  mean_net_conn_t1[i,"DAtt_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Dorsal-Attention","atlas_roi"]), colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Dorsal-Attention","atlas_roi"])],na.rm=T)
  mean_net_conn_t1[i,"Lang_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Language","atlas_roi"]), colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Language","atlas_roi"])],na.rm=T)
  mean_net_conn_t1[i,"Aud_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Auditory","atlas_roi"]), colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Auditory","atlas_roi"])],na.rm=T)
  mean_net_conn_t1[i,"Post_Mult_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Posterior-Multimodal","atlas_roi"]), colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Posterior-Multimodal","atlas_roi"])],na.rm=T)
  mean_net_conn_t1[i,"Vent_Mult_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Ventral-Multimodal","atlas_roi"]), colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Ventral-Multimodal","atlas_roi"])],na.rm=T)
  mean_net_conn_t1[i,"Orb_Aff_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Orbito-Affective","atlas_roi"]), colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Orbito-Affective","atlas_roi"])],na.rm=T)
  mean_net_conn_t1[i,"Bet_Sub_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Subcortical","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_SM_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Somatomotor","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Somatomotor","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_CiOp_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Cingulo-Opercular","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Cingulo-Opercular","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_FrPr_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Frontoparietal","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Frontoparietal","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_DMN_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Default","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Default","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_Vis1_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual1","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual1","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_Vis2_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual2","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual2","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_DAtt_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Dorsal-Attention","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Dorsal-Attention","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_Lang_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Language","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Language","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_Aud_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Auditory","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Auditory","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_Post_Mult_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Posterior-Multimodal","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Posterior-Multimodal","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_Vent_Mult_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Ventral-Multimodal","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Ventral-Multimodal","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_Orb_Aff_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Orbito-Affective","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Orbito-Affective","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_SM_Cort_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Somatomotor","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Somatomotor"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_CiOp_Cort_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Cingulo-Opercular","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Cingulo-Opercular"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_FrPr_Cort_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Frontoparietal","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Frontoparietal"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_DMN_Cort_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Default","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Default"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_Vis1_Cort_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual1","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual1"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_Vis2_Cort_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual2","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual2"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_DAtt_Cort_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Dorsal-Attention","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Dorsal-Attention"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_Lang_Cort_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Language","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Language"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_Aud_Cort_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Auditory","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Auditory"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_Post_Mult_Cort_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Posterior-Multimodal","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Posterior-Multimodal"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_Vent_Mult_Cort_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Ventral-Multimodal","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Ventral-Multimodal"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t1[i,"Bet_Orb_Aff_Cort_t1"] <- mean(cor_rs1_z[[i]][rownames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Orbito-Affective","atlas_roi"]), !(colnames(cor_rs1_z[[i]]) %in% (rois[rois$net_ColeAnt=="Orbito-Affective"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
} 

mean_net_conn_t1$STUDYID <- rownames(mean_net_conn_t1)
mean_net_conn_t1 <- mean_net_conn_t1[,c(39,1:38)]

```

```{r}
# add ROIs as colnames - longitudinal data
for (i in names(RS_ts2)) {
  colnames(RS_ts2[[i]]) <- as.vector(rois$atlas_roi)
}

```

```{r}
# generate longitudinal correlation matrices for each participant for within- and between-network conn
cor_rs2  <- lapply(RS_ts2, cor)

# fisher z transform corrs to normalize dist
cor_rs2_z  <- lapply(cor_rs2, fisherz)

# add ROI names and replace inf values with NA for mean calculations 
for (i in names(cor_rs2_z)) {
  colnames(cor_rs2_z[[i]]) <- as.vector(rois$atlas_roi)
  rownames(cor_rs2_z[[i]]) <- as.vector(rois$atlas_roi)
  cor_rs2_z[[i]][is.infinite(cor_rs2_z[[i]])] <- NA
}

# mean within network corrs
mean_net_conn_t2 <- data.frame()

for (i in names(cor_rs2_z)) {
  mean_net_conn_t2[i,"Sub_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Subcortical","atlas_roi"]), colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Subcortical","atlas_roi"])],na.rm=T)
  mean_net_conn_t2[i,"SM_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Somatomotor","atlas_roi"]), colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Somatomotor","atlas_roi"])],na.rm=T)
  mean_net_conn_t2[i,"CiOp_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Cingulo-Opercular","atlas_roi"]), colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Cingulo-Opercular","atlas_roi"])],na.rm=T)
  mean_net_conn_t2[i,"FrPr_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Frontoparietal","atlas_roi"]), colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Frontoparietal","atlas_roi"])],na.rm=T)
  mean_net_conn_t2[i,"DMN_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Default","atlas_roi"]), colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Default","atlas_roi"])],na.rm=T)
  mean_net_conn_t2[i,"Vis1_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual1","atlas_roi"]), colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual1","atlas_roi"])],na.rm=T)
  mean_net_conn_t2[i,"Vis2_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual2","atlas_roi"]), colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual2","atlas_roi"])],na.rm=T)
  mean_net_conn_t2[i,"DAtt_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Dorsal-Attention","atlas_roi"]), colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Dorsal-Attention","atlas_roi"])],na.rm=T)
  mean_net_conn_t2[i,"Lang_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Language","atlas_roi"]), colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Language","atlas_roi"])],na.rm=T)
  mean_net_conn_t2[i,"Aud_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Auditory","atlas_roi"]), colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Auditory","atlas_roi"])],na.rm=T)
  mean_net_conn_t2[i,"Post_Mult_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Posterior-Multimodal","atlas_roi"]), colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Posterior-Multimodal","atlas_roi"])],na.rm=T)
  mean_net_conn_t2[i,"Vent_Mult_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Ventral-Multimodal","atlas_roi"]), colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Ventral-Multimodal","atlas_roi"])],na.rm=T)
  mean_net_conn_t2[i,"Orb_Aff_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Orbito-Affective","atlas_roi"]), colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Orbito-Affective","atlas_roi"])],na.rm=T)
  mean_net_conn_t2[i,"Bet_Sub_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Subcortical","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_SM_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Somatomotor","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Somatomotor","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_CiOp_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Cingulo-Opercular","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Cingulo-Opercular","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_FrPr_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Frontoparietal","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Frontoparietal","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_DMN_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Default","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Default","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_Vis1_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual1","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual1","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_Vis2_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual2","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual2","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_DAtt_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Dorsal-Attention","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Dorsal-Attention","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_Lang_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Language","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Language","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_Aud_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Auditory","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Auditory","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_Post_Mult_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Posterior-Multimodal","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Posterior-Multimodal","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_Vent_Mult_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Ventral-Multimodal","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Ventral-Multimodal","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_Orb_Aff_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Orbito-Affective","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Orbito-Affective","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_SM_Cort_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Somatomotor","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Somatomotor"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_CiOp_Cort_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Cingulo-Opercular","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Cingulo-Opercular"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_FrPr_Cort_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Frontoparietal","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Frontoparietal"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_DMN_Cort_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Default","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Default"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_Vis1_Cort_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual1","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual1"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_Vis2_Cort_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual2","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Visual2"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_DAtt_Cort_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Dorsal-Attention","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Dorsal-Attention"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_Lang_Cort_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Language","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Language"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_Aud_Cort_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Auditory","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Auditory"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_Post_Mult_Cort_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Posterior-Multimodal","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Posterior-Multimodal"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_Vent_Mult_Cort_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Ventral-Multimodal","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Ventral-Multimodal"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
  mean_net_conn_t2[i,"Bet_Orb_Aff_Cort_t2"] <- mean(cor_rs2_z[[i]][rownames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Orbito-Affective","atlas_roi"]), !(colnames(cor_rs2_z[[i]]) %in% (rois[rois$net_ColeAnt=="Orbito-Affective"|rois$net_ColeAnt=="Subcortical","atlas_roi"]))],na.rm=T)
} 

mean_net_conn_t2$STUDYID <- rownames(mean_net_conn_t2)
mean_net_conn_t2 <- mean_net_conn_t2[,c(39,1:38)]

```

```{r}
# merge clinical and t1 and t2 conn data
mean_net_conn <- merge(mean_net_conn_t1,mean_net_conn_t2,by="STUDYID")
clin_conn <- merge(stpd_clin,mean_net_conn,by="STUDYID")

# create difference score dfs
diff_net_conn <- mean_net_conn_t2[,2:39]-mean_net_conn_t1[,2:39]
colnames(diff_net_conn) <- sub("_t2", "_diff", colnames(diff_net_conn))
diff_net_conn$STUDYID <- row.names(diff_net_conn)
diff_net_conn <- diff_net_conn[,c(39,1:38)]
clin_diff_conn <- merge(stpd_clin,diff_net_conn,by="STUDYID")

# merge t1, t2, and diff data
clin_conn_comb <- merge(clin_conn,diff_net_conn,by="STUDYID")

# write out csv with conn and clinical data 
#write.csv(clin_conn_comb, '/projects/loliver/STOPPD_Long_FC/data/processed/behavioural/STOPPD_clin_net_conn_with_bet_diff_07-05-2022.csv', row.names = FALSE)

```

```{r}
# analyses as per the JAMA psych paper (https://github.com/TIGRLab/STOPPD-MainPaper/) 

# Erin's plot colours
RandomArmColors = c("#e6ab02", "#386cb0")

# table one with baseline values (looking at within and between all 13 networks here)
tbl_t1 <- CreateTableOne(data = clin_conn[,c(6,9:35)],strata = c("RandomArm"))

print(tbl_t1,contDigits = 3)

# table one baseline by site
#CreateTableOne(data = clin_conn[,c(2,6,9:35)],strata = c("RandomArm", "site"))

# table one with longitudinal values
# CreateTableOne(data = clin_conn[,c(6,9,48:73)],strata = c("RandomArm"))

```

```{r}  
# generate df with stats for baseline t-tests
t1_means_df <- data.frame(matrix(NA, nrow = 26, ncol = 5))
rownames(t1_means_df) <- colnames(clin_conn[,10:35])
colnames(t1_means_df) <- c("mean_olan","mean_plac","t","df","p")

for (i in colnames(clin_conn[,10:35])) {
  t1_means_df[i,] <- c(tidy(t.test(get(i) ~ RandomArm, data = clin_conn, paired=F))[,c("estimate1","estimate2","statistic","parameter","p.value")])
}

# add fdr-corrected p values and sd values, then reorder columns 
t1_means_df$p_fdr <- p.adjust(t1_means_df$p, method = "fdr")
t1_means_df$sd_olan <- c(apply(clin_conn[clin_conn$RandomArm=="Olanzapine",10:35], 2, sd))
t1_means_df$sd_plac <- c(apply(clin_conn[clin_conn$RandomArm=="Placebo",10:35], 2, sd))
t1_means_df <- t1_means_df[,c(1,7,2,8,3:6)]

print(t1_means_df)

#write.csv(t1_means_df,file="/projects/loliver/STOPPD_Long_FC/results/t1_means_withbetconn.csv")

```


```{r}
# table one with baseline values in the over 50 sample
CreateTableOne(data = clin_conn[clin_conn$age>50,c(6,9:35)],strata = c("RandomArm"))

# table one with baseline values in the 50 and under sample
CreateTableOne(data = clin_conn[clin_conn$age<=50,c(6,9:35)],strata = c("RandomArm"))

# age histogram for all participants
ggplot(clin_conn, aes(x = age)) + 
  geom_histogram(bins = 25, color = "black", fill = "grey") + 
  geom_vline(xintercept = 50) + 
  theme_minimal()

```

```{r}
# reorganize data to run treatment x time models
clin_conn_long_t1 <- mean_net_conn_t1
clin_conn_long_t1$time <- rep("t1",58)
clin_conn_long_t1 <- merge(stpd_clin,clin_conn_long_t1,by="STUDYID")
colnames(clin_conn_long_t1)[10:47] <- sub("_t1", "", colnames(clin_conn_long_t1)[10:47])

clin_conn_long_t2 <- mean_net_conn_t2
clin_conn_long_t2$time <- rep("t2",58)
clin_conn_long_t2 <- merge(stpd_clin,clin_conn_long_t2,by="STUDYID")
colnames(clin_conn_long_t2)[10:47] <- sub("_t2", "", colnames(clin_conn_long_t2)[10:47])

clin_conn_long <- rbind(clin_conn_long_t1,clin_conn_long_t2)
clin_conn_long$model_days <- ifelse(clin_conn_long$time == "t1", 1, clin_conn_long$dateDiff)

```

```{r}
# primary analyses - mixed linear model - conn treatment x time in full group 
# looking at within-network conn and between each network and all 12 others here

# print full model outputs
for (i in colnames(clin_conn_long[,10:35])) {
  print(i)
  assign(paste0("all_lmer_",i), lmer(get(i) ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), 
  data = clin_conn_long)) %>% summary() %>% print()
}
```

```{r}
# generate df with stats for treatment x time interaction 
trxti_df <- data.frame(matrix(NA, nrow = 5, ncol = 26))
colnames(trxti_df) <- colnames(clin_conn_long[,10:35])
rownames(trxti_df) <- c("beta","SE","df","t","p")

for (i in colnames(clin_conn_long[,10:35])) {
  trxti_df[[i]] <- as.vector(summary(lmer(get(i) ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), 
  data = clin_conn_long))[[10]][6,])
}

# transpose df, add fdr-corrected p values, and reorder columns 
trxti_df <- data.frame(t(trxti_df))
trxti_df$p_fdr <- p.adjust(trxti_df$p, method = "fdr")
trxti_df <- trxti_df[,c(1,2,4,3,5,6)]

print(trxti_df)

#write.csv(trxti_df,file="/projects/loliver/STOPPD_Long_FC/results/treatxtime_withbetconn.csv")

```

```{r}
# FDR correction for sig primary treatment finding (not treatment x time) Bet_Lang
p.adjust(.0376, method = "fdr", n = 26)

```

```{r}
# plot treatment arm x time 
ggplot(clin_conn_long, aes(x=model_days, y=Bet_Vis2, fill = RandomArm)) + 
  geom_point(aes(shape = PlotLabel)) + 
  geom_line(aes(group=STUDYID, color = RandomArm), alpha = 0.5) + 
  geom_smooth(aes(color = RandomArm), method="lm", fill = "grey40") +
  labs(x ="Days between MRIs", 
       y = "Secondary Visual Between-Network Connectivity",
       shape = "Status at scan 2",
       color = "Group") +
  scale_colour_manual(values = RandomArmColors) +
  scale_fill_manual(values = RandomArmColors) +
  scale_shape_manual(values = c(21:23)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank())

ggplot(clin_conn_long, aes(x=model_days, y=Bet_Lang, fill = RandomArm)) + 
  geom_point(aes(shape = PlotLabel)) + 
  geom_line(aes(group=STUDYID, color = RandomArm), alpha = 0.5) + 
  geom_smooth(aes(color = RandomArm), method="lm", fill = "grey40") +
  labs(x ="Days between MRIs", 
       y = "Language Between-Network Connectivity",
       shape = "Status at scan 2",
       color = "Group") +
  scale_colour_manual(values = RandomArmColors) +
  scale_fill_manual(values = RandomArmColors) +
  scale_shape_manual(values = c(21:23)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank())

```

```{r}
# plot clinical outcome x time - olanzapine only 
ggplot(clin_conn_long[clin_conn_long$RandomArm=="Olanzapine",], aes(x=model_days, y=Bet_Vis2, fill = PlotLabel)) + 
  geom_point(aes(shape = PlotLabel)) + 
  geom_line(aes(group=STUDYID, color = PlotLabel), alpha = 0.5) + 
  geom_smooth(aes(color = PlotLabel), method="lm", fill = "lightgrey") +
  labs(x ="Days between MRIs", 
       y = "Secondary Visual Between-Network Connectivity",
       #shape = "Status at scan 2",
       color = "ClinicalOutcome") +
  guides(fill=FALSE) +
  scale_colour_manual(values = c("springgreen1","mediumpurple1","lightpink")) +
  scale_fill_manual(values = c("springgreen1","mediumpurple1","lightpink")) +
  scale_shape_manual(values = c(21:24)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank())

# plot clinical outcome x time - placebo only 
ggplot(clin_conn_long[clin_conn_long$RandomArm=="Placebo",], aes(x=model_days, y=Bet_Vis2, fill = PlotLabel)) + 
  geom_point(aes(shape = PlotLabel)) + 
  geom_line(aes(group=STUDYID, color = PlotLabel), alpha = 0.5) + 
  geom_smooth(aes(color = PlotLabel), method="lm", fill = "lightgrey") +
  labs(x ="Days between MRIs", 
       y = "Secondary Visual Between-Network Connectivity",
       #shape = "Status at scan 2",
       color = "ClinicalOutcome") +
  guides(fill=FALSE) +
  scale_colour_manual(values = c("springgreen1","mediumpurple1","lightpink")) +
  scale_fill_manual(values = c("springgreen1","mediumpurple1","lightpink")) +
  scale_shape_manual(values = c(21:24)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank())

```

```{r}
# sensitivity analysis excluding off protocol - N=53
for (i in colnames(clin_conn_long[,10:35])) {
  print(i)
  assign(paste0("all_sens1_lmer_",i), lmer(get(i) ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), 
  data = clin_conn_long[clin_conn_long$ClinicalOutcome != "Off protocol",])) %>% summary() %>% print()
}

```

```{r}
# generate df with stats for treatment x time interaction - sensitivity analysis 1 
trxti_sens1_df <- data.frame(matrix(NA, nrow = 5, ncol = 26))
colnames(trxti_sens1_df) <- colnames(clin_conn_long[,10:35])
rownames(trxti_sens1_df) <- c("beta","SE","df","t","p")

for (i in colnames(clin_conn_long[,10:35])) {
  trxti_sens1_df[[i]] <- as.vector(summary(lmer(get(i) ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), 
  data = clin_conn_long[clin_conn_long$ClinicalOutcome != "Off protocol",]))[[10]][6,])
}

# transpose df and add fdr-corrected p values 
trxti_sens1_df <- data.frame(t(trxti_sens1_df))
trxti_sens1_df$p_fdr <- p.adjust(trxti_sens1_df$p, method = "fdr")
trxti_sens1_df <- trxti_sens1_df[,c(1,2,4,3,5,6)]

print(trxti_sens1_df)

#write.csv(trxti_sens1_df,file="/projects/loliver/STOPPD_Long_FC/results/treatxtime_withbetconn_sens_off_prot.csv")

```

```{r}
# FDR correction for sig treatment only findings
p.adjust(.0245, method = "fdr", n = 26)
p.adjust(.0239, method = "fdr", n = 26)
p.adjust(.0225, method = "fdr", n = 26)
p.adjust(.0307, method = "fdr", n = 26)
p.adjust(.0379, method = "fdr", n = 26)

```

```{r}
# sensitivity analyses for age > 50 - N=34
for (i in colnames(clin_conn_long[,10:35])) {
  print(i)
  assign(paste0("all_sens2_lmer_",i), lmer(get(i) ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), 
  data = clin_conn_long[clin_conn_long$age>50,])) %>% summary() %>% print()
}

```

```{r}
# generate df with stats for treatment x time interaction - sensitivity analysis 2 
trxti_sens2_df <- data.frame(matrix(NA, nrow = 5, ncol = 26))
colnames(trxti_sens2_df) <- colnames(clin_conn_long[,10:35])
rownames(trxti_sens2_df) <- c("beta","SE","df","t","p")

for (i in colnames(clin_conn_long[,10:35])) {
  trxti_sens2_df[[i]] <- as.vector(summary(lmer(get(i) ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), 
  data = clin_conn_long[clin_conn_long$age>50,]))[[10]][6,])
}

# transpose df and add fdr-corrected p values 
trxti_sens2_df <- data.frame(t(trxti_sens2_df))
trxti_sens2_df$p_fdr <- p.adjust(trxti_sens2_df$p, method = "fdr")
trxti_sens2_df <- trxti_sens2_df[,c(1,2,4,3,5,6)]

print(trxti_sens2_df)

#write.csv(trxti_sens2_df,file="/projects/loliver/STOPPD_Long_FC/results/treatxtime_withbetconn_sens_over50.csv")

```

```{r}
# FDR correction for sig treatment only and time only findings
p.adjust(.0201, method = "fdr", n = 26)
p.adjust(.0337, method = "fdr", n = 26)

```

```{r}
# sensitivity analyses for age <= 50 - N=24
for (i in colnames(clin_conn_long[,10:35])) {
  print(i)
  assign(paste0("all_sens3_lmer_",i), lmer(get(i) ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), 
  data = clin_conn_long[clin_conn_long$age<=50,])) %>% summary() %>% print()
}

```

```{r}
# generate df with stats for treatment x time interaction - sensitivity analysis 3 
trxti_sens3_df <- data.frame(matrix(NA, nrow = 5, ncol = 26))
colnames(trxti_sens3_df) <- colnames(clin_conn_long[,10:35])
rownames(trxti_sens3_df) <- c("beta","SE","df","t","p")

for (i in colnames(clin_conn_long[,10:35])) {
  trxti_sens3_df[[i]] <- as.vector(summary(lmer(get(i) ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), 
  data = clin_conn_long[clin_conn_long$age<=50,]))[[10]][6,])
}

# transpose df and add fdr-corrected p values 
trxti_sens3_df <- data.frame(t(trxti_sens3_df))
trxti_sens3_df$p_fdr <- p.adjust(trxti_sens3_df$p, method = "fdr")
trxti_sens3_df <- trxti_sens3_df[,c(1,2,4,3,5,6)]

print(trxti_sens3_df)

#write.csv(trxti_sens3_df,file="/projects/loliver/STOPPD_Long_FC/results/treatxtime_withbetconn_sens_50under.csv")

```

```{r}
# FDR correction for sig treatment findings
p.adjust(.0359, method = "fdr", n = 26)
p.adjust(.0032, method = "fdr", n = 26)

```

```{r}
# table one in remitters only
# updated to exclude discontinuers to ensure all second scans at 36 weeks - N = 30
CreateTableOne(data = clin_conn[clin_conn$ClinicalOutcome=="Remission" & clin_conn$PlotLabel!="Discontinued",c(6,9:35,48:73)],strata = c("RandomArm"))

# table one in remitters only (difference scores)
CreateTableOne(data = clin_diff_conn[clin_diff_conn$ClinicalOutcome=="Remission" & clin_conn$PlotLabel!="Discontinued",c(6,9:35)],strata = c("RandomArm"))

```

```{r}
# secondary analyses - conn treatment in remitters only (sustained remission, discontinuers removed) # N=30
rem_clin_diff_conn <- clin_diff_conn %>% filter(ClinicalOutcome == "Remission" & PlotLabel != "Discontinued") 

for (i in colnames(rem_clin_diff_conn[,10:35])) {
  print(i)
  assign(paste0("rem_lmer_",i), lmer(get(i) ~ RandomArm + sex + age + (1|site), 
  data = rem_clin_diff_conn)) %>% summary() %>% print()
}

```

```{r}
# generate df with stats for treatment
rem_tr_df <- data.frame(matrix(NA, nrow = 5, ncol = 26))
colnames(rem_tr_df) <- colnames(rem_clin_diff_conn[,10:35])
rownames(rem_tr_df) <- c("beta","SE","df","t","p")

for (i in colnames(rem_clin_diff_conn[,10:35])) {
  rem_tr_df[[i]] <- as.vector(summary(lmer(get(i) ~ RandomArm + sex + age + (1|site), 
  data = rem_clin_diff_conn))[[10]][2,])
}

# transpose df and add fdr-corrected p values 
rem_tr_df <- data.frame(t(rem_tr_df))
rem_tr_df$p_fdr <- p.adjust(rem_tr_df$p, method = "fdr")
rem_tr_df <- rem_tr_df[,c(1,2,4,3,5,6)]

print(rem_tr_df)

#write.csv(rem_tr_df,file="/projects/loliver/STOPPD_Long_FC/results/rem_tr_withbetconn.csv")

```


```{r fig.height=4.25, fig.width=6}
# boxplot of difference in conn metrics (y axis) by RandomArm group (x axis) in remitters only 

ggplot(rem_clin_diff_conn, aes(x= RandomArm, y = SM_diff, fill = RandomArm)) + 
     geom_boxplot(outlier.shape = NA, alpha = 0.0001) + 
     geom_dotplot(binaxis = 'y', stackdir = 'center') +
     geom_hline(yintercept = 0) +
     labs( x=NULL,      
           y = bquote('Change in Somatomotor Within-Network Connectivity'),
           fill = "Group") +
     scale_fill_manual(values = RandomArmColors) +
     scale_shape_manual(values = c(21)) +
 #    facet_wrap(~Region) + could use for densities
     theme_bw() +
     theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank())

ggplot(rem_clin_diff_conn, aes(x= RandomArm, y = Vent_Mult_diff, fill = RandomArm)) + 
     geom_boxplot(outlier.shape = NA, alpha = 0.0001) + 
     geom_dotplot(binaxis = 'y', stackdir = 'center') +
     geom_hline(yintercept = 0) +
     labs( x=NULL,      
           y = bquote('Change in Ventral Multimodal Within-Network Connectivity'),
           fill = "Group") +
     scale_fill_manual(values = RandomArmColors) +
     scale_shape_manual(values = c(21)) +
 #    facet_wrap(~Region) + could use for densities
     theme_bw() +
     theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank())

ggplot(rem_clin_diff_conn, aes(x= RandomArm, y = Bet_Vis2_diff, fill = RandomArm)) + 
     geom_boxplot(outlier.shape = NA, alpha = 0.0001) + 
     geom_dotplot(binaxis = 'y', stackdir = 'center') +
     geom_hline(yintercept = 0) +
     labs( x=NULL,      
           y = bquote('Change in Secondary Visual Between-Network Connectivity'),
           fill = "Group") +
     scale_fill_manual(values = RandomArmColors) +
     scale_shape_manual(values = c(21)) +
 #    facet_wrap(~Region) + could use for densities
     theme_bw() +
     theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank())

```


```{r}
# secondary sensitivity analysis excluding off protocol - no off protocol in remitter only sample

```

```{r}
# secondary sensitivity analyses for age > 50 - N=15
for (i in colnames(rem_clin_diff_conn[,10:35])) {
  print(i)
  assign(paste0("rem_sens2_lmer_",i), lmer(get(i) ~ RandomArm + sex + age + (1|site), 
  data = rem_clin_diff_conn[rem_clin_diff_conn$age>50,])) %>% summary() %>% print()
}

```

```{r}
# generate df with stats for treatment - sensitivity analysis 2
rem_tr_sens2_df <- data.frame(matrix(NA, nrow = 5, ncol = 26))
colnames(rem_tr_sens2_df) <- colnames(rem_clin_diff_conn[,10:35])
rownames(rem_tr_sens2_df) <- c("beta","SE","df","t","p")

for (i in colnames(rem_clin_diff_conn[,10:35])) {
  rem_tr_sens2_df[[i]] <- as.vector(summary(lmer(get(i) ~ RandomArm + sex + age + (1|site), 
  data = rem_clin_diff_conn[rem_clin_diff_conn$age>50,]))[[10]][2,])
}

# transpose df and add fdr-corrected p values 
rem_tr_sens2_df <- data.frame(t(rem_tr_sens2_df))
rem_tr_sens2_df$p_fdr <- p.adjust(rem_tr_sens2_df$p, method = "fdr")
rem_tr_sens2_df <- rem_tr_sens2_df[,c(1,2,4,3,5,6)]

print(rem_tr_sens2_df)

#write.csv(rem_tr_sens2_df,file="/projects/loliver/STOPPD_Long_FC/results/rem_tr_withbetconn_sens_over50.csv")

```


```{r}
# secondary sensitivity analyses for age <= 50 - N=15
for (i in colnames(rem_clin_diff_conn[,10:35])) {
  print(i)
  assign(paste0("rem_sens3_lmer_",i), lmer(get(i) ~ RandomArm + sex + age + (1|site), 
  data = rem_clin_diff_conn[rem_clin_diff_conn$age<=50,])) %>% summary() %>% print()
}

```

```{r}
# generate df with stats for treatment - sensitivity analysis 3
rem_tr_sens3_df <- data.frame(matrix(NA, nrow = 5, ncol = 26))
colnames(rem_tr_sens3_df) <- colnames(rem_clin_diff_conn[,10:35])
rownames(rem_tr_sens3_df) <- c("beta","SE","df","t","p")

for (i in colnames(rem_clin_diff_conn[,10:35])) {
  rem_tr_sens3_df[[i]] <- as.vector(summary(lmer(get(i) ~ RandomArm + sex + age + (1|site), 
  data = rem_clin_diff_conn[rem_clin_diff_conn$age<=50,]))[[10]][2,])
}

# transpose df and add fdr-corrected p values 
rem_tr_sens3_df <- data.frame(t(rem_tr_sens3_df))
rem_tr_sens3_df$p_fdr <- p.adjust(rem_tr_sens3_df$p, method = "fdr")
rem_tr_sens3_df <- rem_tr_sens3_df[,c(1,2,4,3,5,6)]

print(rem_tr_sens3_df)

#write.csv(rem_tr_sens3_df,file="/projects/loliver/STOPPD_Long_FC/results/rem_tr_withbetconn_sens_50under.csv")

```


```{r}
# table one in relapsers only
CreateTableOne(data = clin_conn[clin_conn$ClinicalOutcome=="Relapse",c(6,9:35,48:73)],strata = c("RandomArm"))

# table one in relapsers only (difference scores)
CreateTableOne(data = clin_diff_conn[clin_diff_conn$ClinicalOutcome=="Relapse",c(6,9:35)],strata = c("RandomArm"))

```

```{r}
# exploratory analysis - treatment in relapsers only # N=21
rel_clin_diff_conn <- clin_diff_conn %>% filter(ClinicalOutcome == "Relapse") 

for (i in colnames(rel_clin_diff_conn[,10:35])) {
  print(i)
  assign(paste0("rel_lmer_",i), lmer(get(i) ~ RandomArm + sex + age + (1|site), 
  data = rel_clin_diff_conn)) %>% summary() %>% print()
}

```

```{r}
# generate df with stats for treatment - relapsers only
rel_tr_df <- data.frame(matrix(NA, nrow = 5, ncol = 26))
colnames(rel_tr_df) <- colnames(rel_clin_diff_conn[,10:35])
rownames(rel_tr_df) <- c("beta","SE","df","t","p")

for (i in colnames(rel_clin_diff_conn[,10:35])) {
  rel_tr_df[[i]] <- as.vector(summary(lmer(get(i) ~ RandomArm + sex + age + (1|site), 
  data = rel_clin_diff_conn))[[10]][2,])
}

# transpose df and add fdr-corrected p values 
rel_tr_df <- data.frame(t(rel_tr_df))
rel_tr_df$p_fdr <- p.adjust(rel_tr_df$p, method = "fdr")
rel_tr_df <- rel_tr_df[,c(1,2,4,3,5,6)]

print(rel_tr_df)

#write.csv(rel_tr_df,file="/projects/loliver/STOPPD_Long_FC/results/exp_rel_tr_withbetconn.csv")

```

```{r fig.height=4, fig.width=7}
# boxplot of difference in conn metrics (y axis) by RandomArm group (x axis) in relapsers only - all NS

ggplot(rel_clin_diff_conn, aes(x= RandomArm, y = SM_diff, fill = RandomArm)) + 
     geom_boxplot(outlier.shape = NA, alpha = 0.0001) + 
     geom_dotplot(binaxis = 'y', stackdir = 'center') +
     geom_hline(yintercept = 0) +
     labs( x=NULL,      
           y = bquote('Change in SM Within Network Connectivity'),
           fill = "Group") +
     scale_fill_manual(values = RandomArmColors) +
     scale_shape_manual(values = c(21)) +
 #    facet_wrap(~Region) + could use for densities
     theme_bw() +
     theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank())

ggplot(rel_clin_diff_conn, aes(x= RandomArm, y = Bet_Vis2_diff, fill = RandomArm)) + 
     geom_boxplot(outlier.shape = NA, alpha = 0.0001) + 
     geom_dotplot(binaxis = 'y', stackdir = 'center') +
     geom_hline(yintercept = 0) +
     labs( x=NULL,      
           y = bquote('Change in Vis2 Between Network Connectivity'),
           fill = "Group") +
     scale_fill_manual(values = RandomArmColors) +
     scale_shape_manual(values = c(21)) +
 #    facet_wrap(~Region) + could use for densities
     theme_bw() +
     theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank())

```

```{r}
# exploratory analysis - t-tests for diffs by clinical outcome in placebo only N=29 (11 remitters vs 18 relapsers)

plac_clin_diff_conn <- clin_diff_conn[clin_diff_conn$RandomArm=="Placebo" & (clin_diff_conn$ClinicalOutcome=="Remission" | clin_diff_conn$ClinicalOutcome=="Relapse"),]

for (i in colnames(plac_clin_diff_conn[,10:35])) {
  print(i)
  t.test(get(i) ~ ClinicalOutcome, data = plac_clin_diff_conn, paired=F) %>% print()
}

```

```{r}
# generate df with stats for placebo only
plac_df <- data.frame(matrix(NA, nrow = 26, ncol = 5))
rownames(plac_df) <- colnames(plac_clin_diff_conn[,10:35])
colnames(plac_df) <- c("mean_rem","mean_rel","t","df","p")

for (i in colnames(plac_clin_diff_conn[,10:35])) {
  plac_df[i,] <- c(tidy(t.test(get(i) ~ ClinicalOutcome, data = plac_clin_diff_conn, paired=F))[,c("estimate1","estimate2","statistic","parameter","p.value")])
}

# add fdr-corrected p values 
plac_df$p_fdr <- p.adjust(plac_df$p, method = "fdr")

print(plac_df)

#write.csv(plac_df,file="/projects/loliver/STOPPD_Long_FC/results/exp_placebo_withbetconn.csv")

```

```{r}
# exploratory analysis - t-tests for diffs by clinical outcome in olanzapine only N=24 (21 remitters vs 3 relapsers)

olan_clin_diff_conn <- clin_diff_conn[clin_diff_conn$RandomArm=="Olanzapine" & (clin_diff_conn$ClinicalOutcome=="Remission" | clin_diff_conn$ClinicalOutcome=="Relapse"),]

for (i in colnames(olan_clin_diff_conn[,10:35])) {
  print(i)
  t.test(get(i) ~ ClinicalOutcome, data = olan_clin_diff_conn, paired=F) %>% print()
}

```

```{r}
# generate df with stats for olanzapine only
olan_df <- data.frame(matrix(NA, nrow = 26, ncol = 5))
rownames(olan_df) <- colnames(olan_clin_diff_conn[,10:35])
colnames(olan_df) <- c("mean_rem","mean_rel","t","df","p")

for (i in colnames(olan_clin_diff_conn[,10:35])) {
  olan_df[i,] <- c(tidy(t.test(get(i) ~ ClinicalOutcome, data = olan_clin_diff_conn, paired=F))[,c("estimate1","estimate2","statistic","parameter","p.value")])
}

# add fdr-corrected p values 
olan_df$p_fdr <- p.adjust(olan_df$p, method = "fdr")

print(olan_df)

#write.csv(olan_df,file="/projects/loliver/STOPPD_Long_FC/results/exp_olanzapine_withbetconn.csv")

```

```{r}
# exploratory analysis - t-tests for diffs by clinical outcome across treatment groups N=53 (32 remitters vs 21 relapsers)

treat_clin_diff_conn <- clin_diff_conn[clin_diff_conn$ClinicalOutcome=="Remission" | clin_diff_conn$ClinicalOutcome=="Relapse",]

for (i in colnames(treat_clin_diff_conn[,10:35])) {
  print(i)
  t.test(get(i) ~ ClinicalOutcome, data = treat_clin_diff_conn, paired=F) %>% print()
}

```

```{r}
# generate df with stats across treatment groups
treat_df <- data.frame(matrix(NA, nrow = 26, ncol = 5))
rownames(treat_df) <- colnames(treat_clin_diff_conn[,10:35])
colnames(treat_df) <- c("mean_rem","mean_rel","t","df","p")

for (i in colnames(treat_clin_diff_conn[,10:35])) {
  treat_df[i,] <- c(tidy(t.test(get(i) ~ ClinicalOutcome, data = treat_clin_diff_conn, paired=F))[,c("estimate1","estimate2","statistic","parameter","p.value")])
}

# add fdr-corrected p values 
treat_df$p_fdr <- p.adjust(treat_df$p, method = "fdr")

print(treat_df)

#write.csv(treat_df,file="/projects/loliver/STOPPD_Long_FC/results/exp_acrosstreat_withbetconn.csv")

```

```{r}
# exploratory analysis - t-tests for diffs in remitters across treatment groups N = 32

rem_clin_conn_long <- clin_conn_long[clin_conn_long$ClinicalOutcome=="Remission",]

for (i in colnames(rem_clin_conn_long[,10:35])) {
  print(i)
  t.test(get(i) ~ time, data = rem_clin_conn_long, paired=T) %>% print()
}

# calculate cohen's d for these diffs
for (i in colnames(rem_clin_conn_long[,10:35])) {
  print(i)
  cohen.d(get(i) ~ time, data = rem_clin_conn_long) %>% print()
}

# means and SDs for Bet_DAtt at T1 and T2
mean(rem_clin_conn_long[rem_clin_conn_long$time=="t1","Bet_DAtt"])
sd(rem_clin_conn_long[rem_clin_conn_long$time=="t1","Bet_DAtt"])
mean(rem_clin_conn_long[rem_clin_conn_long$time=="t2","Bet_DAtt"])
sd(rem_clin_conn_long[rem_clin_conn_long$time=="t2","Bet_DAtt"])

```

```{r}
# generate df with stats in remitters across treatment groups
# mean diffs are t1-t2 (not intuitive; negative reflects an increase)
rem_df <- data.frame(matrix(NA, nrow = 26, ncol = 4))
rownames(rem_df) <- colnames(rem_clin_conn_long[,10:35])
colnames(rem_df) <- c("mean_diff","t","df","p")

for (i in colnames(rem_clin_conn_long[,10:35])) {
  rem_df[i,] <- c(tidy(t.test(get(i) ~ time, data = rem_clin_conn_long, paired=T))[,c("estimate","statistic","parameter","p.value")])
}

# add fdr-corrected p values 
rem_df$p_fdr <- p.adjust(rem_df$p, method = "fdr")

print(rem_df)

#write.csv(rem_df,file="/projects/loliver/STOPPD_Long_FC/results/exp_remtime_withbetconn.csv")

```

```{r}
# exploratory analysis - t-tests for diffs in relapsers across treatment groups N = 21

rel_clin_conn_long <- clin_conn_long[clin_conn_long$ClinicalOutcome=="Relapse",]

for (i in colnames(rel_clin_conn_long[,10:35])) {
  print(i)
  t.test(get(i) ~ time, data = rel_clin_conn_long, paired=T) %>% print()
}

# calculate cohen's d for these diffs
for (i in colnames(rel_clin_conn_long[,10:35])) {
  print(i)
  cohen.d(get(i) ~ time, data = rel_clin_conn_long) %>% print()
}

# means and SDs for FrPr at T1 and T2
mean(rel_clin_conn_long[rel_clin_conn_long$time=="t1","FrPr"])
sd(rel_clin_conn_long[rel_clin_conn_long$time=="t1","FrPr"])
mean(rel_clin_conn_long[rel_clin_conn_long$time=="t2","FrPr"])
sd(rel_clin_conn_long[rel_clin_conn_long$time=="t2","FrPr"])

```

```{r}
# generate df with stats in relapsers across treatment groups 
# mean diffs are t1-t2 (not intuitive; negative reflects an increase)
rel_df <- data.frame(matrix(NA, nrow = 26, ncol = 4))
rownames(rel_df) <- colnames(rel_clin_conn_long[,10:35])
colnames(rel_df) <- c("mean_diff","t","df","p")

for (i in colnames(rel_clin_conn_long[,10:35])) {
  rel_df[i,] <- c(tidy(t.test(get(i) ~ time, data = rel_clin_conn_long, paired=T))[,c("estimate","statistic","parameter","p.value")])
}

# add fdr-corrected p values 
rel_df$p_fdr <- p.adjust(rel_df$p, method = "fdr")

print(rel_df)

#write.csv(rel_df,file="/projects/loliver/STOPPD_Long_FC/results/exp_reltime_withbetconn.csv")

```


Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
